<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Index Login Redirect Test - FishTalk</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .test-container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #6366F1;
    }
    .test-section h2 {
      color: #4A90E2;
      font-size: 18px;
      margin-bottom: 15px;
      margin-top: 0;
    }
    .btn {
      padding: 12px 24px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #6366F1;
      color: white;
    }
    .btn-primary:hover {
      background: #4F46E5;
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: #10B981;
      color: white;
    }
    .btn-secondary:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: #EF4444;
      color: white;
    }
    .btn-danger:hover {
      background: #DC2626;
      transform: translateY(-2px);
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      line-height: 1.6;
    }
    .status.info {
      background: #E3F2FD;
      border: 1px solid #2196F3;
      color: #1565C0;
    }
    .status.success {
      background: #E8F5E9;
      border: 1px solid #4CAF50;
      color: #2E7D32;
    }
    .status.warning {
      background: #FFF3E0;
      border: 1px solid #FF9800;
      color: #E65100;
    }
    .status.error {
      background: #FFEBEE;
      border: 1px solid #F44336;
      color: #C62828;
    }
    code {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .current-value {
      font-weight: bold;
      color: #6366F1;
    }
    ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    li {
      margin: 8px 0;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ§ª ä¸»é¡µç™»å½•é‡å®šå‘æµ‹è¯•</h1>
    <div class="subtitle">æµ‹è¯•ä¸»é¡µç™»å½•åä¸ä¼šè·³è½¬åˆ° tank é¡µé¢çš„ä¿®å¤</div>

    <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
    <div class="test-section">
      <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
      <div>
        <strong>å½“å‰é¡µé¢ï¼š</strong> 
        <span class="current-value" id="current-page"></span>
      </div>
      <div style="margin-top: 10px;">
        <strong>localStorage.loginRedirectï¼š</strong> 
        <span class="current-value" id="current-redirect"></span>
      </div>
      <button class="btn btn-secondary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    </div>

    <!-- æµ‹è¯•1ï¼šæ¨¡æ‹Ÿè®¾ç½®æ—§çš„ loginRedirect -->
    <div class="test-section">
      <h2>æµ‹è¯• 1ï¼šæ¨¡æ‹Ÿæ—§çš„ loginRedirect</h2>
      <p>æ¨¡æ‹Ÿç”¨æˆ·ä¹‹å‰è®¿é—®è¿‡ tank é¡µé¢ï¼Œç³»ç»Ÿä¿å­˜äº† loginRedirectã€‚</p>
      <button class="btn btn-primary" onclick="setOldRedirect()">
        è®¾ç½® loginRedirect = "tank.html?view=my"
      </button>
      <button class="btn btn-danger" onclick="clearRedirect()">
        æ¸…é™¤ loginRedirect
      </button>
      <div id="test1-status" class="status info">
        â³ ç‚¹å‡»æŒ‰é’®è®¾ç½®æµ‹è¯•æ•°æ®...
      </div>
    </div>

    <!-- æµ‹è¯•2ï¼šæ£€æŸ¥ä¸»é¡µç™»å½•è¡Œä¸º -->
    <div class="test-section">
      <h2>æµ‹è¯• 2ï¼šæ£€æŸ¥ä¸»é¡µç™»å½•è¡Œä¸º</h2>
      <p>éªŒè¯åœ¨ä¸»é¡µæ‰“å¼€ç™»å½•æ¨¡æ€æ¡†æ—¶æ˜¯å¦æ¸…é™¤æ—§çš„ loginRedirectã€‚</p>
      <div style="margin-bottom: 15px;">
        <strong>å‰ç½®æ¡ä»¶ï¼š</strong> å…ˆè¿è¡Œæµ‹è¯•1è®¾ç½®æ—§çš„ loginRedirect
      </div>
      <button class="btn btn-primary" onclick="goToIndex()">
        ğŸ“ è·³è½¬åˆ°ä¸»é¡µæµ‹è¯•
      </button>
      <div id="test2-status" class="status info">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®è·³è½¬åˆ°ä¸»é¡µ</li>
          <li>åœ¨ä¸»é¡µç‚¹å‡»"Sign In"æŒ‰é’®</li>
          <li>è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºæ˜¯å¦æœ‰ï¼š<br>
              <code>ğŸ§¹ Clearing existing loginRedirect on index page</code>
          </li>
          <li>ç‚¹å‡»ä»»æ„ OAuth æŒ‰é’®ï¼ˆGoogle/Discordï¼‰</li>
          <li>è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºæ˜¯å¦æœ‰ï¼š<br>
              <code>ğŸ§¹ Clearing existing loginRedirect before OAuth</code>
          </li>
        </ol>
      </div>
    </div>

    <!-- æµ‹è¯•3ï¼šæ£€æŸ¥é‚®ç®±ç™»å½•è¡Œä¸º -->
    <div class="test-section">
      <h2>æµ‹è¯• 3ï¼šæ£€æŸ¥é‚®ç®±ç™»å½•è¡Œä¸º</h2>
      <p>éªŒè¯ä»ä¸»é¡µç‚¹å‡»é‚®ç®±ç™»å½•æ—¶ä½¿ç”¨çš„ redirectUrlã€‚</p>
      <button class="btn btn-primary" onclick="testEmailLogin()">
        ğŸ“§ æµ‹è¯•é‚®ç®±ç™»å½•ï¼ˆä¸ä¼šçœŸæ­£è·³è½¬ï¼‰
      </button>
      <div id="test3-status" class="status info">
        <strong>é¢„æœŸè¡Œä¸ºï¼š</strong><br>
        ä»ä¸»é¡µç‚¹å‡»é‚®ç®±ç™»å½•æ—¶ï¼Œåº”è¯¥ä½¿ç”¨ <code>window.location.href</code>ï¼ˆå½“å‰é¡µé¢ï¼‰ï¼Œ<br>
        è€Œä¸æ˜¯æ—§çš„ <code>localStorage.loginRedirect</code>ã€‚
      </div>
    </div>

    <!-- æµ‹è¯•4ï¼šå®Œæ•´æµç¨‹æµ‹è¯• -->
    <div class="test-section">
      <h2>æµ‹è¯• 4ï¼šå®Œæ•´æµç¨‹ï¼ˆéœ€è¦çœŸå®ç™»å½•ï¼‰</h2>
      <p>å®Œæ•´æµ‹è¯•ä»è®¾ç½®åˆ°ç™»å½•çš„æ•´ä¸ªæµç¨‹ã€‚</p>
      <div style="margin-bottom: 15px;">
        <strong>âš ï¸ æ³¨æ„ï¼š</strong> æ­¤æµ‹è¯•éœ€è¦çœŸå®çš„ OAuth ç™»å½•ï¼Œè¯·ç¡®ä¿æœ‰æµ‹è¯•è´¦å·ã€‚
      </div>
      <ol>
        <li>è¿è¡Œæµ‹è¯•1ï¼Œè®¾ç½® <code>loginRedirect = "tank.html?view=my"</code></li>
        <li>ç‚¹å‡»"è·³è½¬åˆ°ä¸»é¡µæµ‹è¯•"</li>
        <li>åœ¨ä¸»é¡µç‚¹å‡»"Sign In"æŒ‰é’®</li>
        <li>é€‰æ‹© Google æˆ– Discord ç™»å½•</li>
        <li>å®Œæˆ OAuth ç™»å½•</li>
        <li>âœ… éªŒè¯ï¼šç™»å½•ååº”è¯¥ç•™åœ¨ä¸»é¡µï¼Œè€Œä¸æ˜¯è·³è½¬åˆ° tank é¡µé¢</li>
      </ol>
      <button class="btn btn-primary" onclick="startFullTest()">
        ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•
      </button>
      <div id="test4-status" class="status info">
        â³ ç‚¹å‡»æŒ‰é’®å¼€å§‹å®Œæ•´æµ‹è¯•...
      </div>
    </div>

    <!-- é¢„æœŸè¡Œä¸º -->
    <div class="test-section">
      <h2>âœ… é¢„æœŸè¡Œä¸ºæ€»ç»“</h2>
      <ul>
        <li>âœ¨ åœ¨ä¸»é¡µæ‰“å¼€ç™»å½•æ¨¡æ€æ¡†æ—¶ï¼Œæ¸…é™¤æ—§çš„ loginRedirect</li>
        <li>âœ¨ åœ¨ä¸»é¡µç‚¹å‡» OAuth ç™»å½•æ—¶ï¼Œæ¸…é™¤æ—§çš„ loginRedirect</li>
        <li>âœ¨ åœ¨ä¸»é¡µç‚¹å‡»é‚®ç®±ç™»å½•æ—¶ï¼Œå¿½ç•¥æ—§çš„ loginRedirectï¼Œä½¿ç”¨å½“å‰é¡µé¢</li>
        <li>âœ¨ ä»å…¶ä»–é¡µé¢ç™»å½•æ—¶ï¼Œä»ç„¶æ­£å¸¸ä½¿ç”¨ loginRedirectï¼ˆä¿æŒç°æœ‰åŠŸèƒ½ï¼‰</li>
        <li>âœ¨ ç™»å½•åç•™åœ¨ä¸»é¡µï¼Œä¸è·³è½¬åˆ° tank æˆ–å…¶ä»–é¡µé¢</li>
      </ul>
    </div>

    <!-- å›åˆ°ä¸»é¡µ -->
    <div style="text-align: center; margin-top: 30px;">
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">
        ğŸ  è¿”å›ä¸»é¡µ
      </button>
    </div>
  </div>

  <script>
    // åˆ·æ–°å½“å‰çŠ¶æ€
    function refreshStatus() {
      const currentPage = window.location.pathname;
      const currentRedirect = localStorage.getItem('loginRedirect') || '(æœªè®¾ç½®)';
      
      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('current-redirect').textContent = currentRedirect;
      
      console.log('ğŸ“Š Current status:', { currentPage, currentRedirect });
    }

    // è®¾ç½®æ—§çš„ loginRedirect
    function setOldRedirect() {
      localStorage.setItem('loginRedirect', 'tank.html?view=my');
      refreshStatus();
      
      const status = document.getElementById('test1-status');
      status.className = 'status success';
      status.innerHTML = 'âœ… å·²è®¾ç½® loginRedirect = "tank.html?view=my"<br><small>ç°åœ¨å¯ä»¥è¿›è¡Œåç»­æµ‹è¯•äº†</small>';
      
      console.log('âœ… Set loginRedirect to tank.html?view=my');
    }

    // æ¸…é™¤ loginRedirect
    function clearRedirect() {
      localStorage.removeItem('loginRedirect');
      refreshStatus();
      
      const status = document.getElementById('test1-status');
      status.className = 'status info';
      status.innerHTML = 'â„¹ï¸ å·²æ¸…é™¤ loginRedirect';
      
      console.log('ğŸ§¹ Cleared loginRedirect');
    }

    // è·³è½¬åˆ°ä¸»é¡µæµ‹è¯•
    function goToIndex() {
      const currentRedirect = localStorage.getItem('loginRedirect');
      
      if (!currentRedirect) {
        const status = document.getElementById('test2-status');
        status.className = 'status warning';
        status.innerHTML = 'âš ï¸ è¯·å…ˆè¿è¡Œæµ‹è¯•1è®¾ç½® loginRedirect';
        return;
      }
      
      console.log('ğŸ“ Navigating to index.html with loginRedirect:', currentRedirect);
      window.location.href = 'index.html';
    }

    // æµ‹è¯•é‚®ç®±ç™»å½•ï¼ˆä¸çœŸæ­£è·³è½¬ï¼‰
    function testEmailLogin() {
      const currentPath = window.location.pathname;
      const isOnIndex = currentPath === '/' || 
                        currentPath === '/index.html' || 
                        currentPath.endsWith('/index.html');
      
      let redirectUrl;
      if (isOnIndex) {
        redirectUrl = window.location.href;
        console.log('ğŸ“ Email login from index page, redirectUrl:', redirectUrl);
      } else {
        redirectUrl = localStorage.getItem('loginRedirect') || window.location.href;
        console.log('ğŸ“ Email login from other page, redirectUrl:', redirectUrl);
      }
      
      const status = document.getElementById('test3-status');
      status.className = 'status success';
      status.innerHTML = `
        âœ… æ¨¡æ‹Ÿé‚®ç®±ç™»å½•é€»è¾‘ï¼š<br>
        <strong>å½“å‰é¡µé¢ï¼š</strong> ${currentPath}<br>
        <strong>æ˜¯å¦åœ¨ä¸»é¡µï¼š</strong> ${isOnIndex ? 'æ˜¯' : 'å¦'}<br>
        <strong>ä½¿ç”¨çš„ redirectUrlï¼š</strong> <code>${redirectUrl}</code><br>
        <br>
        ${isOnIndex ? 
          'âœ… æ­£ç¡®ï¼šåœ¨ä¸»é¡µä½¿ç”¨å½“å‰é¡µé¢ï¼Œå¿½ç•¥æ—§çš„ loginRedirect' : 
          'âœ… æ­£ç¡®ï¼šåœ¨å…¶ä»–é¡µé¢ä½¿ç”¨ loginRedirect æˆ–å½“å‰é¡µé¢'}
      `;
    }

    // å¼€å§‹å®Œæ•´æµ‹è¯•
    function startFullTest() {
      // è®¾ç½® loginRedirect
      localStorage.setItem('loginRedirect', 'tank.html?view=my');
      
      const status = document.getElementById('test4-status');
      status.className = 'status warning';
      status.innerHTML = `
        ğŸš€ å®Œæ•´æµ‹è¯•å·²å¼€å§‹ï¼<br>
        <br>
        <strong>æ­¥éª¤ï¼š</strong><br>
        1. âœ… å·²è®¾ç½® loginRedirect = "tank.html?view=my"<br>
        2. â³ å³å°†è·³è½¬åˆ°ä¸»é¡µ...<br>
        3. ğŸ“‹ è¯·åœ¨ä¸»é¡µå®Œæˆç™»å½•<br>
        4. ğŸ¯ éªŒè¯ç™»å½•åæ˜¯å¦ç•™åœ¨ä¸»é¡µ
      `;
      
      console.log('ğŸš€ Full test started, navigating to index.html in 2 seconds...');
      
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2000);
    }

    // é¡µé¢åŠ è½½æ—¶åˆ·æ–°çŠ¶æ€
    refreshStatus();

    // æ£€æŸ¥æ˜¯å¦ä»ä¸»é¡µè¿”å›
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('from_index')) {
      const redirectValue = localStorage.getItem('loginRedirect');
      if (redirectValue) {
        const status = document.getElementById('test2-status');
        status.className = 'status error';
        status.innerHTML = `
          âŒ æµ‹è¯•å¤±è´¥ï¼<br>
          loginRedirect ä»ç„¶å­˜åœ¨ï¼š<code>${redirectValue}</code><br>
          <br>
          <strong>å¯èƒ½åŸå› ï¼š</strong><br>
          - ä¿®å¤ä»£ç æœªç”Ÿæ•ˆ<br>
          - æœªåœ¨ä¸»é¡µç‚¹å‡»ç™»å½•æŒ‰é’®
        `;
      } else {
        const status = document.getElementById('test2-status');
        status.className = 'status success';
        status.innerHTML = 'âœ… æµ‹è¯•é€šè¿‡ï¼loginRedirect å·²è¢«æ¸…é™¤ã€‚';
      }
    }
  </script>
</body>
</html>

