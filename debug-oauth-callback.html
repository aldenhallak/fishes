<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OAuth å›è°ƒè°ƒè¯•</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .section {
      background: #252526;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 3px solid #007acc;
    }
    .title {
      color: #4ec9b0;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .param {
      color: #ce9178;
      margin: 5px 0;
    }
    .value {
      color: #9cdcfe;
    }
    .error {
      color: #f48771;
      border-left-color: #f48771;
    }
    .success {
      color: #4ec9b0;
      border-left-color: #4ec9b0;
    }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ” OAuth å›è°ƒè°ƒè¯•å·¥å…·</h1>
  
  <div class="section">
    <div class="title">ğŸ“ å½“å‰ URL</div>
    <div class="param">å®Œæ•´ URL: <span class="value" id="fullUrl"></span></div>
    <div class="param">Origin: <span class="value" id="origin"></span></div>
    <div class="param">Pathname: <span class="value" id="pathname"></span></div>
    <div class="param">Search: <span class="value" id="search"></span></div>
    <div class="param">Hash: <span class="value" id="hash"></span></div>
  </div>

  <div class="section">
    <div class="title">ğŸ”‘ Query String å‚æ•°</div>
    <div id="queryParams"></div>
  </div>

  <div class="section">
    <div class="title">ğŸ”— Hash Fragment å‚æ•°</div>
    <div id="hashParams"></div>
  </div>

  <div class="section" id="errorSection" style="display: none;">
    <div class="title">âŒ OAuth é”™è¯¯</div>
    <div id="errorDetails"></div>
  </div>

  <div class="section" id="tokenSection" style="display: none;">
    <div class="title">âœ… OAuth Token</div>
    <div id="tokenDetails"></div>
  </div>

  <div class="section">
    <div class="title">ğŸ“‹ Supabase Session çŠ¶æ€</div>
    <div id="sessionStatus">ç­‰å¾… Supabase åˆå§‹åŒ–...</div>
  </div>

  <div class="section">
    <div class="title">ğŸ’¡ å»ºè®®æ“ä½œ</div>
    <div id="suggestions"></div>
  </div>

  <script src="/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // æ˜¾ç¤º URL ä¿¡æ¯
    document.getElementById('fullUrl').textContent = window.location.href;
    document.getElementById('origin').textContent = window.location.origin;
    document.getElementById('pathname').textContent = window.location.pathname;
    document.getElementById('search').textContent = window.location.search || '(ç©º)';
    document.getElementById('hash').textContent = window.location.hash || '(ç©º)';

    // è§£æ Query String
    const urlParams = new URLSearchParams(window.location.search);
    const queryParamsDiv = document.getElementById('queryParams');
    if (urlParams.toString()) {
      let html = '';
      for (const [key, value] of urlParams) {
        html += `<div class="param">${key}: <span class="value">${value}</span></div>`;
      }
      queryParamsDiv.innerHTML = html;
    } else {
      queryParamsDiv.innerHTML = '<div class="param">(æ— å‚æ•°)</div>';
    }

    // è§£æ Hash Fragment
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const hashParamsDiv = document.getElementById('hashParams');
    if (hashParams.toString()) {
      let html = '';
      for (const [key, value] of hashParams) {
        // æˆªæ–­ token æ˜¾ç¤º
        const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
        html += `<div class="param">${key}: <span class="value">${displayValue}</span></div>`;
      }
      hashParamsDiv.innerHTML = html;
    } else {
      hashParamsDiv.innerHTML = '<div class="param">(æ— å‚æ•°)</div>';
    }

    // æ£€æŸ¥é”™è¯¯
    const error = urlParams.get('error') || hashParams.get('error');
    const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
    
    if (error) {
      const errorSection = document.getElementById('errorSection');
      errorSection.style.display = 'block';
      errorSection.classList.add('error');
      
      let errorHtml = `<div class="param">é”™è¯¯ä»£ç : <span class="value">${error}</span></div>`;
      if (errorDescription) {
        errorHtml += `<div class="param">é”™è¯¯æè¿°: <span class="value">${decodeURIComponent(errorDescription)}</span></div>`;
      }
      document.getElementById('errorDetails').innerHTML = errorHtml;
    }

    // æ£€æŸ¥ token
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');
    const expiresIn = hashParams.get('expires_in');
    
    if (accessToken) {
      const tokenSection = document.getElementById('tokenSection');
      tokenSection.style.display = 'block';
      tokenSection.classList.add('success');
      
      let tokenHtml = `<div class="param">âœ… Access Token: <span class="value">${accessToken.substring(0, 20)}...</span></div>`;
      if (refreshToken) {
        tokenHtml += `<div class="param">âœ… Refresh Token: <span class="value">${refreshToken.substring(0, 20)}...</span></div>`;
      }
      if (expiresIn) {
        tokenHtml += `<div class="param">â±ï¸ è¿‡æœŸæ—¶é—´: <span class="value">${expiresIn} ç§’</span></div>`;
      }
      document.getElementById('tokenDetails').innerHTML = tokenHtml;
    }

    // ç­‰å¾… Supabase é…ç½®åŠ è½½
    window.addEventListener('supabaseConfigReady', async () => {
      const sessionStatusDiv = document.getElementById('sessionStatus');
      
      try {
        // åˆå§‹åŒ– Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        
        sessionStatusDiv.innerHTML = '<div class="param">â³ æ­£åœ¨æ£€æŸ¥ session...</div>';
        
        // è·å– session
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          sessionStatusDiv.innerHTML = `<div class="param error">âŒ Session é”™è¯¯: ${sessionError.message}</div>`;
        } else if (session) {
          sessionStatusDiv.innerHTML = `
            <div class="param success">âœ… Session å·²å»ºç«‹</div>
            <div class="param">ç”¨æˆ· ID: <span class="value">${session.user.id}</span></div>
            <div class="param">é‚®ç®±: <span class="value">${session.user.email || '(æ— )'}</span></div>
            <div class="param">Provider: <span class="value">${session.user.app_metadata?.provider || '(æœªçŸ¥)'}</span></div>
            <div class="param">è¿‡æœŸæ—¶é—´: <span class="value">${new Date(session.expires_at * 1000).toLocaleString()}</span></div>
          `;
          
          // æ˜¾ç¤ºç”¨æˆ·å…ƒæ•°æ®
          if (session.user.user_metadata) {
            sessionStatusDiv.innerHTML += `
              <div class="param">ç”¨æˆ·å…ƒæ•°æ®:</div>
              <pre>${JSON.stringify(session.user.user_metadata, null, 2)}</pre>
            `;
          }
        } else {
          sessionStatusDiv.innerHTML = '<div class="param">â„¹ï¸ æœªæ‰¾åˆ° session</div>';
        }
        
        // ç”Ÿæˆå»ºè®®
        const suggestionsDiv = document.getElementById('suggestions');
        let suggestions = '';
        
        if (error) {
          suggestions += `
            <div class="param error">âŒ OAuth æˆæƒå¤±è´¥</div>
            <div class="param">1. æ£€æŸ¥ Supabase Dashboard ä¸­ Discord Provider æ˜¯å¦æ­£ç¡®é…ç½®</div>
            <div class="param">2. æ£€æŸ¥ Client ID å’Œ Client Secret æ˜¯å¦æ­£ç¡®</div>
            <div class="param">3. æ£€æŸ¥ Discord Application ä¸­çš„ Redirect URI æ˜¯å¦åŒ¹é…</div>
          `;
        } else if (accessToken && !session) {
          suggestions += `
            <div class="param error">âš ï¸ æœ‰ Token ä½†æ²¡æœ‰ Session</div>
            <div class="param">1. å¯èƒ½æ˜¯ Supabase å¤„ç† token æ—¶å‡ºé”™</div>
            <div class="param">2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯</div>
            <div class="param">3. å°è¯•æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•</div>
          `;
        } else if (session) {
          suggestions += `
            <div class="param success">âœ… OAuth ç™»å½•æˆåŠŸï¼</div>
            <div class="param">å¯ä»¥è¿”å›åº”ç”¨ç»§ç»­ä½¿ç”¨</div>
            <div class="param"><a href="/index.html" style="color: #4ec9b0;">è¿”å›é¦–é¡µ</a></div>
          `;
        } else {
          suggestions += `
            <div class="param">â„¹ï¸ è¿™ä¸æ˜¯ OAuth å›è°ƒé¡µé¢</div>
            <div class="param">å¦‚æœä½ åˆšå®Œæˆ OAuth æˆæƒï¼Œè¯·æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°äº†é”™è¯¯çš„é¡µé¢</div>
          `;
        }
        
        suggestionsDiv.innerHTML = suggestions;
        
      } catch (err) {
        sessionStatusDiv.innerHTML = `<div class="param error">âŒ åˆå§‹åŒ–å¤±è´¥: ${err.message}</div>`;
      }
    });

    // å¦‚æœ 5 ç§’åè¿˜æ²¡åŠ è½½é…ç½®ï¼Œæ˜¾ç¤ºé”™è¯¯
    setTimeout(() => {
      if (!window.supabaseConfigReady) {
        document.getElementById('sessionStatus').innerHTML = 
          '<div class="param error">âŒ Supabase é…ç½®åŠ è½½è¶…æ—¶</div>';
      }
    }, 5000);
  </script>
</body>
</html>
