<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜ API å®Œæ•´æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin-bottom: 15px;
      color: #2d3748;
    }
    .status {
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5a67d8;
    }
    .btn-success {
      background: #48bb78;
      color: white;
    }
    .btn-success:hover {
      background: #38a169;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .endpoint {
      font-family: 'Courier New', monospace;
      background: #e2e8f0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-get { background: #bee3f8; color: #2c5282; }
    .badge-put { background: #feebc8; color: #7c2d12; }
    .badge-delete { background: #fed7d7; color: #742a2a; }
    .quick-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ§ª ç®¡ç†å‘˜ API å®Œæ•´æµ‹è¯•</h1>
    <p>æµ‹è¯•æ‰€æœ‰ç®¡ç†å‘˜ç›¸å…³çš„ API ç«¯ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
  </div>

  <div class="test-section">
    <h2>ğŸ“‹ å¿«é€Ÿè®¿é—®é“¾æ¥</h2>
    <div class="quick-links">
      <a href="/admin-table-manager.html" class="btn btn-primary" target="_blank">
        è¡¨ç®¡ç†å™¨é¡µé¢
      </a>
      <a href="/admin-table-edit.html?table=user_subscriptions" class="btn btn-primary" target="_blank">
        ç¼–è¾‘ user_subscriptions
      </a>
      <a href="/admin-table-edit.html?table=fish" class="btn btn-primary" target="_blank">
        ç¼–è¾‘ fish
      </a>
      <a href="/admin-table-edit.html?table=group_chat" class="btn btn-primary" target="_blank">
        ç¼–è¾‘ group_chat
      </a>
    </div>
  </div>

  <!-- Test 1: è¡¨åˆ—è¡¨ API -->
  <div class="test-section">
    <h2>Test 1: è¡¨åˆ—è¡¨ API</h2>
    <p>
      <span class="badge badge-get">GET</span>
      <span class="endpoint">/api/admin/tables</span>
    </p>
    <button class="btn btn-success" onclick="testTablesList()">è¿è¡Œæµ‹è¯•</button>
    <div id="test1-result"></div>
  </div>

  <!-- Test 2: è¡¨æ•°æ® API -->
  <div class="test-section">
    <h2>Test 2: è¡¨æ•°æ® API</h2>
    <p>
      <span class="badge badge-get">GET</span>
      <span class="endpoint">/api/admin/tables/{tableName}</span>
    </p>
    <button class="btn btn-success" onclick="testTableData()">è¿è¡Œæµ‹è¯•</button>
    <div id="test2-result"></div>
  </div>

  <!-- Test 3: å¤šä¸ªè¡¨æµ‹è¯• -->
  <div class="test-section">
    <h2>Test 3: æ‰¹é‡è¡¨è®¿é—®æµ‹è¯•</h2>
    <p>æµ‹è¯•å¤šä¸ªå¸¸ç”¨è¡¨çš„ API è®¿é—®</p>
    <button class="btn btn-success" onclick="testMultipleTables()">è¿è¡Œæµ‹è¯•</button>
    <div id="test3-result"></div>
  </div>

  <!-- Summary -->
  <div class="test-section">
    <h2>ğŸ“Š æµ‹è¯•æ€»ç»“</h2>
    <div id="summary">
      <div class="info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
    </div>
  </div>

  <script>
    let testResults = {
      passed: 0,
      failed: 0,
      total: 0
    };

    async function testTablesList() {
      const resultDiv = document.getElementById('test1-result');
      resultDiv.innerHTML = '<div class="info">ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...</div>';

      try {
        const response = await fetch('/api/admin/tables');
        const data = await response.json();

        let html = '';
        if (response.ok && data.success) {
          html += '<div class="success">âœ… æµ‹è¯•é€šè¿‡ï¼</div>';
          html += `<div class="info">æ‰¾åˆ° ${data.data.tables.length} ä¸ªæ•°æ®è¡¨</div>`;
          html += '<pre>' + JSON.stringify(data, null, 2).substring(0, 500) + '...</pre>';
          testResults.passed++;
        } else {
          html += '<div class="error">âŒ æµ‹è¯•å¤±è´¥</div>';
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          testResults.failed++;
        }
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
        testResults.failed++;
      }
      
      testResults.total++;
      updateSummary();
    }

    async function testTableData() {
      const resultDiv = document.getElementById('test2-result');
      resultDiv.innerHTML = '<div class="info">ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...</div>';

      try {
        const tableName = 'user_subscriptions';
        const response = await fetch(`/api/admin/tables/${tableName}?limit=3`);
        const data = await response.json();

        let html = '';
        if (response.ok && data.success) {
          html += '<div class="success">âœ… æµ‹è¯•é€šè¿‡ï¼</div>';
          html += `<div class="info">è¡¨: ${data.data.tableName}</div>`;
          html += `<div class="info">åˆ—æ•°: ${data.data.columns.length}</div>`;
          html += `<div class="info">è¡Œæ•°: ${data.data.rows.length}</div>`;
          html += '<pre>' + JSON.stringify(data, null, 2).substring(0, 800) + '...</pre>';
          testResults.passed++;
        } else {
          html += '<div class="error">âŒ æµ‹è¯•å¤±è´¥</div>';
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          testResults.failed++;
        }
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
        testResults.failed++;
      }
      
      testResults.total++;
      updateSummary();
    }

    async function testMultipleTables() {
      const resultDiv = document.getElementById('test3-result');
      resultDiv.innerHTML = '<div class="info">ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...</div>';

      const tables = ['fish', 'users', 'group_chat', 'votes'];
      let html = '';
      let passed = 0;
      let failed = 0;

      for (const tableName of tables) {
        try {
          const response = await fetch(`/api/admin/tables/${tableName}?limit=1`);
          const data = await response.json();

          if (response.ok && data.success) {
            html += `<div class="success">âœ… ${tableName}: æˆåŠŸ (${data.data.columns?.length || 0} åˆ—)</div>`;
            passed++;
          } else {
            html += `<div class="error">âŒ ${tableName}: å¤±è´¥ - ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
            failed++;
          }
        } catch (error) {
          html += `<div class="error">âŒ ${tableName}: è¯·æ±‚å¤±è´¥ - ${error.message}</div>`;
          failed++;
        }
      }

      html += `<div class="info">æ€»è®¡: ${passed} é€šè¿‡, ${failed} å¤±è´¥</div>`;
      resultDiv.innerHTML = html;
      
      testResults.passed += passed;
      testResults.failed += failed;
      testResults.total++;
      updateSummary();
    }

    function updateSummary() {
      const summaryDiv = document.getElementById('summary');
      const successRate = testResults.total > 0 
        ? Math.round((testResults.passed / (testResults.passed + testResults.failed)) * 100) 
        : 0;

      summaryDiv.innerHTML = `
        <div class="info">
          <strong>å·²è¿è¡Œæµ‹è¯•:</strong> ${testResults.total} ç»„<br>
          <strong>é€šè¿‡:</strong> ${testResults.passed} ä¸ª<br>
          <strong>å¤±è´¥:</strong> ${testResults.failed} ä¸ª<br>
          <strong>æˆåŠŸç‡:</strong> ${successRate}%
        </div>
        ${successRate === 100 && testResults.total >= 3 ? 
          '<div class="success"><strong>ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç®¡ç†å‘˜ API å·¥ä½œæ­£å¸¸ã€‚</strong></div>' : ''}
      `;
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ç®¡ç†å‘˜ API æµ‹è¯•é¡µé¢å·²åŠ è½½');
    });
  </script>
</body>
</html>

