<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Out UI Update Test - FishTalk</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .test-container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #6366F1;
    }
    .test-section h2 {
      color: #4A90E2;
      font-size: 18px;
      margin-bottom: 15px;
      margin-top: 0;
    }
    .btn {
      padding: 12px 24px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #6366F1;
      color: white;
    }
    .btn-primary:hover {
      background: #4F46E5;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: #EF4444;
      color: white;
    }
    .btn-danger:hover {
      background: #DC2626;
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: #10B981;
      color: white;
    }
    .btn-secondary:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      line-height: 1.6;
    }
    .status.info {
      background: #E3F2FD;
      border: 1px solid #2196F3;
      color: #1565C0;
    }
    .status.success {
      background: #E8F5E9;
      border: 1px solid #4CAF50;
      color: #2E7D32;
    }
    .status.warning {
      background: #FFF3E0;
      border: 1px solid #FF9800;
      color: #E65100;
    }
    .status.error {
      background: #FFEBEE;
      border: 1px solid #F44336;
      color: #C62828;
    }
    code {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .log-viewer {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
    }
    .log-entry.success {
      color: #4CAF50;
    }
    .log-entry.error {
      color: #EF4444;
    }
    .log-entry.info {
      color: #2196F3;
    }
    .current-value {
      font-weight: bold;
      color: #6366F1;
    }
    ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    li {
      margin: 8px 0;
      line-height: 1.6;
    }
    .checklist {
      list-style: none;
      padding-left: 0;
    }
    .checklist li {
      padding-left: 30px;
      position: relative;
    }
    .checklist li:before {
      content: 'â˜';
      position: absolute;
      left: 0;
      font-size: 18px;
      color: #999;
    }
    .checklist li.checked:before {
      content: 'â˜‘';
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ§ª Sign Out UI æ›´æ–°æµ‹è¯•</h1>
    <div class="subtitle">æµ‹è¯•é€€å‡ºç™»å½•å UI æ˜¯å¦ç«‹å³æ›´æ–°ï¼Œä¸æ˜¾ç¤ºæ—§ç”¨æˆ·å</div>

    <!-- å½“å‰çŠ¶æ€ -->
    <div class="test-section">
      <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
      <div>
        <strong>ç™»å½•çŠ¶æ€ï¼š</strong> 
        <span class="current-value" id="login-status">æ£€æŸ¥ä¸­...</span>
      </div>
      <div style="margin-top: 10px;">
        <strong>å½“å‰ç”¨æˆ·ï¼š</strong> 
        <span class="current-value" id="current-user">æ£€æŸ¥ä¸­...</span>
      </div>
      <div style="margin-top: 10px;">
        <strong>localStorage.userIdï¼š</strong> 
        <span class="current-value" id="storage-userid"></span>
      </div>
      <div style="margin-top: 10px;">
        <strong>authCache.userï¼š</strong> 
        <span class="current-value" id="cache-user"></span>
      </div>
      <button class="btn btn-secondary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    </div>

    <!-- æµ‹è¯•æ­¥éª¤ -->
    <div class="test-section">
      <h2>ğŸ§ª æµ‹è¯•æ­¥éª¤</h2>
      <ol>
        <li>ç¡®ä¿ä½ å·²ç»ç™»å½•ç³»ç»Ÿ</li>
        <li>ç‚¹å‡»ä¸‹é¢çš„"å‰å¾€ä¸»é¡µ"æŒ‰é’®</li>
        <li>åœ¨ä¸»é¡µä¸Šè§‚å¯Ÿå¯¼èˆªæ æ˜¾ç¤ºçš„ç”¨æˆ·å</li>
        <li>ç‚¹å‡»ç”¨æˆ·èœå• â†’ Sign Out</li>
        <li>ç¡®è®¤é€€å‡º</li>
        <li>âš ï¸ <strong>å…³é”®æ£€æŸ¥ç‚¹</strong>ï¼šè§‚å¯Ÿå¯¼èˆªæ æ˜¯å¦ï¼š
          <ul>
            <li>âœ… ç«‹å³æ˜¾ç¤º"ğŸ‘¤ Sign In"æŒ‰é’®</li>
            <li>âŒ <strong>ä¸ä¼š</strong>çŸ­æš‚æ˜¾ç¤ºä¹‹å‰çš„ç”¨æˆ·å</li>
          </ul>
        </li>
        <li>è¿”å›æœ¬æµ‹è¯•é¡µé¢æŸ¥çœ‹æ—¥å¿—</li>
      </ol>
      <button class="btn btn-primary" onclick="goToIndex()">ğŸ  å‰å¾€ä¸»é¡µæµ‹è¯•</button>
    </div>

    <!-- è‡ªåŠ¨æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ¤– è‡ªåŠ¨ç›‘æ§æµ‹è¯•</h2>
      <p>åœ¨æœ¬é¡µé¢ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–å’Œ UI æ›´æ–°äº‹ä»¶ã€‚</p>
      <button class="btn btn-primary" onclick="startMonitoring()">â–¶ï¸ å¼€å§‹ç›‘æ§</button>
      <button class="btn btn-danger" onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
      <button class="btn btn-secondary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
      
      <div id="monitoring-status" class="status info">
        â¸ï¸ ç›‘æ§æœªå¯åŠ¨
      </div>
      
      <div class="log-viewer" id="log-viewer">
        <div class="log-entry info">ç­‰å¾…äº‹ä»¶...</div>
      </div>
    </div>

    <!-- æ‰‹åŠ¨æ£€æŸ¥æ¸…å• -->
    <div class="test-section">
      <h2>âœ… æ£€æŸ¥æ¸…å•</h2>
      <ul class="checklist">
        <li id="check-1">é€€å‡ºå‰ï¼šå¯¼èˆªæ æ˜¾ç¤ºç”¨æˆ·å</li>
        <li id="check-2">ç‚¹å‡» Sign Out åï¼šç«‹å³æ˜¾ç¤ºç™»å½•æŒ‰é’®</li>
        <li id="check-3">æ²¡æœ‰çŸ­æš‚æ˜¾ç¤ºæ—§ç”¨æˆ·å</li>
        <li id="check-4">localStorage å·²æ¸…é™¤</li>
        <li id="check-5">authCache å·²æ¸…é™¤</li>
        <li id="check-6">æ§åˆ¶å°æ˜¾ç¤ºæ­£ç¡®çš„æ—¥å¿—</li>
        <li id="check-7">é‡æ–°ç™»å½•æ­£å¸¸</li>
      </ul>
      <button class="btn btn-secondary" onclick="toggleCheck(event)">ç‚¹å‡»é¡¹ç›®æ ‡è®°ä¸ºå®Œæˆ</button>
    </div>

    <!-- é¢„æœŸæ—¥å¿— -->
    <div class="test-section">
      <h2>ğŸ“‹ é¢„æœŸæ§åˆ¶å°æ—¥å¿—</h2>
      <p>é€€å‡ºç™»å½•æ—¶ï¼Œæµè§ˆå™¨æ§åˆ¶å°åº”è¯¥æŒ‰é¡ºåºæ˜¾ç¤ºï¼š</p>
      <div class="log-viewer">
        <div class="log-entry info">ğŸ‘‹ Signing out...</div>
        <div class="log-entry success">âœ… ç™»å‡ºæˆåŠŸ</div>
        <div class="log-entry info">ğŸ—‘ï¸ æ¸…é™¤ç™»å½•çŠ¶æ€ç¼“å­˜</div>
        <div class="log-entry success">âœ… å·²ä»localStorageæ¸…é™¤ç”¨æˆ·ä¿¡æ¯</div>
        <div class="log-entry success">âœ… Signed out successfully</div>
        <div class="log-entry info">â„¹ï¸ ç”¨æˆ·æœªç™»å½•</div>
        <div class="log-entry success">âœ… å·²ä»localStorageæ¸…é™¤ç”¨æˆ·ä¿¡æ¯</div>
        <div class="log-entry success">âœ… å·²æ˜¾ç¤ºç™»å½•æŒ‰é’®å¹¶æ¸…é™¤ç”¨æˆ·ä¿¡æ¯</div>
        <div class="log-entry info">ğŸ”” è®¤è¯çŠ¶æ€å˜åŒ–: SIGNED_OUT undefined</div>
      </div>
    </div>

    <!-- è¿”å›ä¸»é¡µ -->
    <div style="text-align: center; margin-top: 30px;">
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">
        ğŸ  è¿”å›ä¸»é¡µ
      </button>
    </div>
  </div>

  <script>
    let monitoringInterval = null;
    let originalConsoleLog = null;

    // åˆ·æ–°å½“å‰çŠ¶æ€
    async function refreshStatus() {
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      const userId = localStorage.getItem('userId');
      const userData = localStorage.getItem('userData');
      const cachedUser = window.authCache ? window.authCache.getCachedUser() : null;
      
      let loginStatus = 'æœªç™»å½•';
      let currentUser = '(æ— )';
      
      if (window.supabaseAuth) {
        try {
          const user = await window.supabaseAuth.getCurrentUser();
          if (user) {
            loginStatus = 'å·²ç™»å½•';
            currentUser = user.email || user.id;
          }
        } catch (error) {
          console.error('Error getting user:', error);
        }
      }
      
      document.getElementById('login-status').textContent = loginStatus;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('storage-userid').textContent = userId || '(æœªè®¾ç½®)';
      document.getElementById('cache-user').textContent = cachedUser ? cachedUser.email : '(æœªç¼“å­˜)';
      
      console.log('ğŸ“Š Status refreshed:', {
        loginStatus,
        currentUser,
        userId,
        cachedUser: cachedUser?.email
      });
    }

    // å‰å¾€ä¸»é¡µ
    function goToIndex() {
      console.log('ğŸ“ Navigating to index.html');
      window.location.href = 'index.html';
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      const logViewer = document.getElementById('log-viewer');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      logEntry.textContent = `[${timestamp}] ${message}`;
      logViewer.appendChild(logEntry);
      logViewer.scrollTop = logViewer.scrollHeight;
    }

    // æ¸…é™¤æ—¥å¿—
    function clearLogs() {
      const logViewer = document.getElementById('log-viewer');
      logViewer.innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…é™¤ï¼Œç­‰å¾…æ–°äº‹ä»¶...</div>';
    }

    // å¼€å§‹ç›‘æ§
    function startMonitoring() {
      if (monitoringInterval) {
        addLog('ç›‘æ§å·²åœ¨è¿è¡Œä¸­', 'warning');
        return;
      }

      const statusDiv = document.getElementById('monitoring-status');
      statusDiv.className = 'status success';
      statusDiv.innerHTML = 'â–¶ï¸ ç›‘æ§ä¸­...';
      
      addLog('å¼€å§‹ç›‘æ§è®¤è¯çŠ¶æ€å’Œ UI æ›´æ–°', 'success');

      // ç›‘å¬ localStorage å˜åŒ–
      window.addEventListener('storage', handleStorageChange);
      
      // ç›‘å¬ DOM å˜åŒ–
      observeDOMChanges();
      
      // å®šæœŸæ£€æŸ¥çŠ¶æ€
      monitoringInterval = setInterval(() => {
        checkAuthState();
      }, 1000);
      
      // åŠ«æŒ console.log æ•è·æ—¥å¿—
      interceptConsoleLog();
    }

    // åœæ­¢ç›‘æ§
    function stopMonitoring() {
      if (!monitoringInterval) {
        addLog('ç›‘æ§æœªå¯åŠ¨', 'warning');
        return;
      }

      clearInterval(monitoringInterval);
      monitoringInterval = null;
      
      window.removeEventListener('storage', handleStorageChange);
      
      if (originalConsoleLog) {
        console.log = originalConsoleLog;
        originalConsoleLog = null;
      }

      const statusDiv = document.getElementById('monitoring-status');
      statusDiv.className = 'status info';
      statusDiv.innerHTML = 'â¸ï¸ ç›‘æ§å·²åœæ­¢';
      
      addLog('ç›‘æ§å·²åœæ­¢', 'info');
    }

    // å¤„ç† storage å˜åŒ–
    function handleStorageChange(event) {
      addLog(`localStorage å˜åŒ–: ${event.key} = ${event.newValue}`, 'info');
    }

    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    let lastAuthState = null;
    async function checkAuthState() {
      const userId = localStorage.getItem('userId');
      const currentState = userId ? 'logged-in' : 'logged-out';
      
      if (lastAuthState !== currentState) {
        if (currentState === 'logged-out') {
          addLog('æ£€æµ‹åˆ°é€€å‡ºç™»å½•ï¼', 'error');
          addLog('æ£€æŸ¥ UI æ˜¯å¦å·²æ›´æ–°...', 'info');
          
          // æ£€æŸ¥ UI æ›´æ–°
          setTimeout(() => {
            const loginBtn = document.querySelector('#login-btn');
            const userContainer = document.querySelector('#user-container');
            
            if (loginBtn && loginBtn.style.display !== 'none') {
              addLog('âœ… ç™»å½•æŒ‰é’®å·²æ˜¾ç¤º', 'success');
            } else {
              addLog('âŒ ç™»å½•æŒ‰é’®æœªæ˜¾ç¤ºï¼', 'error');
            }
            
            if (userContainer && userContainer.style.display === 'none') {
              addLog('âœ… ç”¨æˆ·å®¹å™¨å·²éšè—', 'success');
            } else {
              addLog('âŒ ç”¨æˆ·å®¹å™¨ä»ç„¶å¯è§ï¼', 'error');
            }
          }, 100);
        } else {
          addLog('æ£€æµ‹åˆ°ç™»å½•', 'success');
        }
        lastAuthState = currentState;
      }
    }

    // è§‚å¯Ÿ DOM å˜åŒ–
    function observeDOMChanges() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ  MutationObserver æ¥ç›‘å¬ DOM å˜åŒ–
      // ç”±äºè·¨é¡µé¢é™åˆ¶ï¼Œè¿™é‡Œåªåšç®€å•æ¼”ç¤º
    }

    // åŠ«æŒ console.log
    function interceptConsoleLog() {
      originalConsoleLog = console.log;
      console.log = function(...args) {
        const message = args.join(' ');
        
        // æ•è·ç‰¹å®šçš„æ—¥å¿—
        if (message.includes('Signing out')) {
          addLog(message, 'info');
        } else if (message.includes('Signed out successfully')) {
          addLog(message, 'success');
        } else if (message.includes('æ¸…é™¤')) {
          addLog(message, 'info');
        } else if (message.includes('ç”¨æˆ·æœªç™»å½•')) {
          addLog(message, 'info');
        } else if (message.includes('æ˜¾ç¤ºç™»å½•æŒ‰é’®')) {
          addLog(message, 'success');
        }
        
        // è°ƒç”¨åŸå§‹ console.log
        originalConsoleLog.apply(console, args);
      };
    }

    // åˆ‡æ¢æ£€æŸ¥é¡¹çŠ¶æ€
    function toggleCheck(event) {
      // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ£€æŸ¥é¡¹
      const checkItems = document.querySelectorAll('.checklist li');
      checkItems.forEach(item => {
        item.style.cursor = 'pointer';
        item.onclick = function() {
          this.classList.toggle('checked');
        };
      });
      
      event.target.textContent = 'ç‚¹å‡»ä¸Šæ–¹é¡¹ç›®æ ‡è®°å®ŒæˆçŠ¶æ€';
      event.target.disabled = true;
    }

    // é¡µé¢åŠ è½½æ—¶åˆ·æ–°çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(refreshStatus, 500);
    });

    // æ£€æŸ¥æ˜¯å¦ä»ä¸»é¡µè¿”å›
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('after_signout')) {
      addLog('ä»ä¸»é¡µè¿”å›ï¼Œæ£€æµ‹åˆ°é€€å‡ºç™»å½•æ“ä½œ', 'info');
      refreshStatus();
    }
  </script>
</body>
</html>

