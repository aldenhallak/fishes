<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COZE API ç»¼åˆæµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f7fafc;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    
    h1 {
      color: #1a202c;
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #718096;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid;
    }
    
    .stat-card.characters {
      background: #ebf4ff;
      border-color: #90cdf4;
      color: #2c5282;
    }
    
    .stat-card.modes {
      background: #e6fffa;
      border-color: #81e6d9;
      color: #234e52;
    }
    
    .stat-label {
      font-size: 13px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
    }
    
    .refresh-btn {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      color: #4a5568;
      padding: 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .refresh-btn:hover {
      background: #edf2f7;
    }
    
    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .panel {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    
    .panel-header {
      background: linear-gradient(to right, #f7fafc, #edf2f7);
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.3s;
    }
    
    .panel-header:hover {
      background: linear-gradient(to right, #edf2f7, #e2e8f0);
    }
    
    .panel-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
    }
    
    .panel-icon {
      width: 24px;
      height: 24px;
    }
    
    .panel-body {
      padding: 24px;
      display: none;
    }
    
    .panel-body.expanded {
      display: block;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .section {
      background: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #4299e1;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 6px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      font-family: 'Courier New', monospace;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4299e1;
    }
    
    input:disabled, select:disabled {
      background: #f7fafc;
      cursor: not-allowed;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #4299e1;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #3182ce;
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #38a169;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #cbd5e0;
    }
    
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
    }
    
    .info-grid {
      display: grid;
      gap: 8px;
      font-size: 13px;
      color: #4a5568;
    }
    
    .info-label {
      font-weight: 600;
      color: #1a202c;
    }
    
    .info-value {
      font-family: 'Courier New', monospace;
      color: #4299e1;
    }
    
    .message-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      border: 2px solid;
    }
    
    .message.user {
      background: #ebf8ff;
      border-color: #90cdf4;
    }
    
    .message.assistant {
      background: #f0fff4;
      border-color: #9ae6b4;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #718096;
      margin-bottom: 8px;
    }
    
    .message-role {
      font-weight: 600;
      color: #1a202c;
    }
    
    .message-content {
      font-size: 14px;
      color: #1a202c;
      white-space: pre-wrap;
    }
    
    .log-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .log-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .log-header {
      font-size: 13px;
      font-weight: 600;
      padding-bottom: 8px;
      border-bottom: 2px solid;
    }
    
    .log-header.coze {
      color: #2c5282;
      border-color: #90cdf4;
    }
    
    .log-header.system {
      color: #1a202c;
      border-color: #e2e8f0;
    }
    
    .log-entry {
      padding: 12px;
      border-radius: 6px;
      border: 2px solid;
      font-size: 12px;
    }
    
    .log-entry.coze-request {
      background: #bee3f8;
      border-color: #90cdf4;
    }
    
    .log-entry.coze-response {
      background: #ebf8ff;
      border-color: #90cdf4;
    }
    
    .log-entry.normal {
      background: white;
      border-color: #e2e8f0;
    }
    
    .log-entry.error {
      background: #fff5f5;
      border-color: #fc8181;
    }
    
    .log-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      color: #718096;
    }
    
    .log-type {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      background: white;
    }
    
    .log-title {
      font-weight: 600;
      color: #1a202c;
    }
    
    .log-url {
      font-size: 11px;
      color: #4299e1;
      background: #ebf8ff;
      padding: 4px 8px;
      border-radius: 4px;
      margin: 8px 0;
      word-break: break-all;
    }
    
    .log-data {
      background: #f7fafc;
      padding: 8px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #1a202c;
    }
    
    .no-logs {
      color: #a0aec0;
      font-style: italic;
      text-align: center;
      padding: 40px;
    }
    
    .alert {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
    }
    
    .alert-warning {
      background: #fefcbf;
      border: 1px solid #f6e05e;
      color: #744210;
    }
    
    .alert-info {
      background: #bee3f8;
      border: 1px solid #90cdf4;
      color: #2c5282;
    }
    
    .code {
      background: #edf2f7;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-badge.polling {
      background: #fefcbf;
      color: #744210;
    }
    
    @media (max-width: 768px) {
      .config-grid, .log-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¤– COZE API ç»¼åˆæµ‹è¯•</h1>
      <p class="subtitle">èŠå¤©æµ‹è¯•å’Œå®æ—¶è¯­éŸ³æµ‹è¯•å¹³å° - Fish Community Chat</p>
    </header>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats-grid">
      <div class="stat-card characters">
        <div class="stat-label">å¯ç”¨è§’è‰²</div>
        <div class="stat-value" id="stats-characters">0</div>
      </div>
      <div class="stat-card modes">
        <div class="stat-label">äº¤äº’æ¨¡å¼</div>
        <div class="stat-value" id="stats-modes">0</div>
      </div>
      <button class="refresh-btn" id="refresh-btn" onclick="loadTestData()">
        ğŸ”„ åˆ·æ–°è§’è‰²ä¸äº¤äº’æ¨¡å¼
      </button>
    </div>

    <!-- èŠå¤©æµ‹è¯•é¢æ¿ -->
    <div class="panel">
      <div class="panel-header" onclick="togglePanel(this)">
        <div class="panel-title">
          <span class="panel-icon">ğŸ’¬</span>
          <span>èŠå¤©æµ‹è¯•</span>
        </div>
        <span class="toggle-icon">â–¼</span>
      </div>
      <div class="panel-body expanded">
        <div class="alert alert-info">
          <strong>ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
          1. å¡«å†™ API Key å’Œ Bot IDï¼ˆä¼šè‡ªåŠ¨ä¿å­˜åˆ°localStorageï¼‰<br>
          2. ç‚¹å‡»"åˆ›å»ºä¼šè¯"å»ºç«‹å¯¹è¯<br>
          3. è¾“å…¥æ¶ˆæ¯ç‚¹å‡»"å‘é€"è¿›è¡Œæµ‹è¯•<br>
          4. ä¸‹æ–¹ä¼šæ˜¾ç¤ºå®Œæ•´çš„è¯·æ±‚/å“åº”æ—¥å¿—
        </div>

        <div class="config-grid">
          <!-- åŸºç¡€é…ç½® -->
          <div class="section">
            <div class="section-title">âš™ï¸ åŸºç¡€é…ç½®</div>
            <div class="form-group">
              <label for="user-id">ç”¨æˆ· ID</label>
              <input type="text" id="user-id" value="test-user-123" placeholder="è¾“å…¥ç”¨æˆ· ID" />
            </div>
            <div class="form-group">
              <label for="api-key">COZE API Key *</label>
              <input type="password" id="api-key" placeholder="pat_xxx..." />
            </div>
            <div class="form-group">
              <label for="bot-id">Bot ID *</label>
              <input type="text" id="bot-id" placeholder="7564430661412192308" />
            </div>
            <div class="form-group">
              <label for="base-url">Base URL</label>
              <input type="text" id="base-url" value="https://api.coze.cn" />
            </div>
          </div>

          <!-- ä¼šè¯ä¿¡æ¯ -->
          <div class="section">
            <div class="section-title">ğŸ“‹ å½“å‰ä¼šè¯ä¿¡æ¯</div>
            <div class="info-grid">
              <div>
                <span class="info-label">conversation_idï¼š</span>
                <span class="info-value" id="conversation-id">ï¼ˆå°šæœªåˆ›å»ºï¼‰</span>
              </div>
              <div>
                <span class="info-label">chat_idï¼š</span>
                <span class="info-value" id="chat-id">ï¼ˆå°šæœªå‘é€æ¶ˆæ¯ï¼‰</span>
              </div>
              <div>
                <span class="info-label">ä½¿ç”¨çš„ Bot IDï¼š</span>
                <span class="info-value" id="effective-bot-id">ï¼ˆæœªè®¾ç½®ï¼‰</span>
              </div>
              <div>
                <span class="status-badge polling" id="polling-status" style="display:none;">
                  è½®è¯¢ä¸­ (1/2)
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- æ“ä½œåŒº -->
        <div class="section">
          <div class="section-title">ğŸ® æ“ä½œ</div>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="createConversation()">
              åˆ›å»ºä¼šè¯
            </button>
            <button class="btn btn-success" id="send-msg-btn" onclick="sendMessage()" disabled>
              å‘é€æ¶ˆæ¯
            </button>
            <button class="btn btn-secondary" onclick="clearLogs()">
              æ¸…ç©ºæ—¥å¿—
            </button>
            <button class="btn btn-secondary" onclick="copyLogs('coze')">
              å¤åˆ¶COZEæ—¥å¿—
            </button>
            <button class="btn btn-secondary" onclick="copyLogs('system')">
              å¤åˆ¶ç³»ç»Ÿæ—¥å¿—
            </button>
            <button class="btn btn-secondary" onclick="copyLogs('all')">
              å¤åˆ¶æ‰€æœ‰æ—¥å¿—
            </button>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label for="message-input">æ¶ˆæ¯å†…å®¹</label>
            <textarea id="message-input" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯..." rows="3"></textarea>
          </div>
          <button class="btn btn-success" onclick="sendMessage()" id="send-btn-2" disabled>
            ğŸ“¤ å‘é€
          </button>
        </div>

        <!-- ä¼šè¯æ¶ˆæ¯ -->
        <div class="section">
          <div class="section-title">ğŸ’¬ ä¼šè¯æ¶ˆæ¯</div>
          <div id="messages-container" class="message-list">
            <div class="no-logs">æš‚æ— æ¶ˆæ¯ï¼Œå…ˆå‘é€ä¸€æ¡è¯•è¯•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- COZE API æ—¥å¿— -->
    <div class="panel">
      <div class="panel-header" onclick="togglePanel(this)">
        <div class="panel-title">
          <span class="panel-icon">ğŸ“Š</span>
          <span>COZE API æ—¥å¿—</span>
        </div>
        <span class="toggle-icon">â–¼</span>
      </div>
      <div class="panel-body expanded">
        <div class="alert alert-warning">
          <strong>ğŸ’¡ æ—¥å¿—è¯´æ˜ï¼š</strong><br>
          å·¦ä¾§ä¸º COZE åŸå§‹è¯·æ±‚/å“åº”ï¼Œå³ä¾§ä¸ºç³»ç»Ÿæ—¥å¿—ã€‚é¢œè‰²æ ‡è¯†ï¼šğŸŸ¦ è¯·æ±‚ / ğŸ”µ å“åº” / âšª ç³»ç»Ÿ / ğŸ”´ é”™è¯¯
        </div>

        <div class="log-container">
          <!-- COZE æ—¥å¿— -->
          <div class="log-column">
            <div class="log-header coze">ğŸ”µ COZE åŸå§‹æ—¥å¿—</div>
            <div id="coze-logs">
              <div class="no-logs">æš‚æ—  COZE æ—¥å¿—</div>
            </div>
          </div>

          <!-- ç³»ç»Ÿæ—¥å¿— -->
          <div class="log-column">
            <div class="log-header system">âšª ç³»ç»Ÿæ—¥å¿—</div>
            <div id="system-logs">
              <div class="no-logs">æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    const state = {
      conversationId: '',
      chatId: '',
      messages: [],
      logs: [],
      isPolling: false,
      pollingAttempts: 0,
      pollingTimeout: null
    };

    const MAX_POLL_ATTEMPTS = 10;  // å‚ç…§AIGF_web ChatInterface
    const POLL_INTERVAL_MS = 3000; // 3ç§’é—´éš”ï¼ˆä¿å®ˆä¸€ç‚¹ï¼‰

    // é¡µé¢åŠ è½½æ—¶æ¢å¤é…ç½®
    window.addEventListener('DOMContentLoaded', async () => {
      // å…ˆå°è¯•ä»APIåŠ è½½ç¯å¢ƒå˜é‡
      try {
        const response = await fetch('/api/coze/config');
        const result = await response.json();
        
        if (result.success && result.data) {
          if (result.data.apiKeyFull) {
            document.getElementById('api-key').value = result.data.apiKeyFull;
            addLog('âœ… ä»ç¯å¢ƒå˜é‡åŠ è½½ API Key', { masked: result.data.apiKey });
          }
          if (result.data.botId) {
            document.getElementById('bot-id').value = result.data.botId;
            addLog('âœ… ä»ç¯å¢ƒå˜é‡åŠ è½½ Bot ID', { botId: result.data.botId });
          }
          if (result.data.baseUrl) {
            document.getElementById('base-url').value = result.data.baseUrl;
          }
        }
      } catch (error) {
        console.warn('æ— æ³•ä»APIåŠ è½½é…ç½®ï¼Œå°è¯•ä»localStorageè¯»å–:', error);
      }
      
      // å¦‚æœAPIæ²¡æœ‰é…ç½®ï¼Œä»localStorageæ¢å¤
      const savedApiKey = localStorage.getItem('coze_api_key');
      const savedBotId = localStorage.getItem('coze_bot_id');
      
      if (!document.getElementById('api-key').value && savedApiKey) {
        document.getElementById('api-key').value = savedApiKey;
        addLog('ğŸ“¦ ä»localStorageæ¢å¤ API Key');
      }
      if (!document.getElementById('bot-id').value && savedBotId) {
        document.getElementById('bot-id').value = savedBotId;
        addLog('ğŸ“¦ ä»localStorageæ¢å¤ Bot ID');
      }

      // ä¿å­˜é…ç½®åˆ°localStorage
      ['api-key', 'bot-id'].forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
          if (e.target.value) {
            localStorage.setItem(`coze_${id.replace('-', '_')}`, e.target.value);
          }
        });
      });

      // å›è½¦å‘é€
      document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });

    // æŠ˜å é¢æ¿
    function togglePanel(header) {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      body.classList.toggle('expanded');
      icon.textContent = body.classList.contains('expanded') ? 'â–¼' : 'â–¶';
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(title, data, logType = 'normal', url = null) {
      const log = {
        title,
        data,
        logType,
        url,
        timestamp: new Date().toISOString()
      };
      state.logs.push(log);

      // åˆ†ç±»æ˜¾ç¤º
      if (logType === 'coze-request' || logType === 'coze-response') {
        appendCozeLog(log);
      } else {
        appendSystemLog(log);
      }
    }

    // æ·»åŠ  COZE æ—¥å¿—
    function appendCozeLog(log) {
      const container = document.getElementById('coze-logs');
      if (container.querySelector('.no-logs')) {
        container.innerHTML = '';
      }

      const entry = document.createElement('div');
      entry.className = `log-entry ${log.logType}`;
      
      const typeLabel = log.logType === 'coze-request' ? 'ğŸŸ¦ è¯·æ±‚' : 'ğŸ”µ å“åº”';
      
      entry.innerHTML = `
        <div class="log-title-row">
          <div>
            <span class="log-type">${typeLabel}</span>
            <span class="log-title">${log.title}</span>
          </div>
          <span>${new Date(log.timestamp).toLocaleTimeString()}</span>
        </div>
        ${log.url ? `<div class="log-url">URL: ${log.url}</div>` : ''}
        <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>
      `;
      // æ’å…¥åˆ°é¡¶éƒ¨è€Œä¸æ˜¯åº•éƒ¨
      container.insertBefore(entry, container.firstChild);
    }

    // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
    function appendSystemLog(log) {
      const container = document.getElementById('system-logs');
      if (container.querySelector('.no-logs')) {
        container.innerHTML = '';
      }

      const entry = document.createElement('div');
      entry.className = `log-entry ${log.logType}`;
      
      const typeLabel = log.logType === 'error' ? 'ğŸ”´ é”™è¯¯' : 'âšª ç³»ç»Ÿ';
      
      entry.innerHTML = `
        <div class="log-title-row">
          <div>
            <span class="log-type">${typeLabel}</span>
            <span class="log-title">${log.title}</span>
          </div>
          <span>${new Date(log.timestamp).toLocaleTimeString()}</span>
        </div>
        <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>
      `;
      // æ’å…¥åˆ°é¡¶éƒ¨è€Œä¸æ˜¯åº•éƒ¨
      container.insertBefore(entry, container.firstChild);
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
      state.logs = [];
      document.getElementById('coze-logs').innerHTML = '<div class="no-logs">æš‚æ—  COZE æ—¥å¿—</div>';
      document.getElementById('system-logs').innerHTML = '<div class="no-logs">æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>';
    }

    // å¤åˆ¶æ—¥å¿—
    async function copyLogs(type) {
      let logs;
      if (type === 'coze') {
        logs = state.logs.filter(l => l.logType === 'coze-request' || l.logType === 'coze-response');
      } else if (type === 'system') {
        logs = state.logs.filter(l => l.logType !== 'coze-request' && l.logType !== 'coze-response');
      } else {
        logs = state.logs;
      }

      if (logs.length === 0) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥å¿—');
        return;
      }

      try {
        await navigator.clipboard.writeText(JSON.stringify(logs, null, 2));
        addLog('å¤åˆ¶æˆåŠŸ', { count: logs.length, type });
      } catch (error) {
        addLog('å¤åˆ¶å¤±è´¥', { error: error.message }, 'error');
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°æ˜¾ç¤ºåŒº
    function addMessage(role, content) {
      const container = document.getElementById('messages-container');
      if (container.querySelector('.no-logs')) {
        container.innerHTML = '';
      }

      const msg = document.createElement('div');
      msg.className = `message ${role}`;
      msg.innerHTML = `
        <div class="message-header">
          <span class="message-role">${role === 'user' ? 'ç”¨æˆ·' : 'AI'}</span>
          <span>${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="message-content">${content}</div>
      `;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }

    // åˆ›å»ºä¼šè¯
    async function createConversation() {
      const apiKey = document.getElementById('api-key').value.trim();
      const botId = document.getElementById('bot-id').value.trim();
      const userId = document.getElementById('user-id').value.trim();
      const baseUrl = document.getElementById('base-url').value.trim();

      if (!apiKey || !botId) {
        alert('è¯·å¡«å†™ API Key å’Œ Bot ID');
        return;
      }

      addLog('åˆ›å»ºä¼šè¯è¯·æ±‚', { bot_id: botId, user_id: userId });

      try {
        const response = await fetch(`${baseUrl}/v1/conversation/create`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            bot_id: botId,
            user_id: userId
          })
        });

        const data = await response.json();
        addLog('COZEåˆ›å»ºä¼šè¯åŸå§‹å“åº”', data, 'coze-response');

        if (response.ok) {
          state.conversationId = data.conversation_id || data.data?.id || '';
          document.getElementById('conversation-id').textContent = state.conversationId;
          document.getElementById('effective-bot-id').textContent = botId;
          document.getElementById('send-msg-btn').disabled = false;
          document.getElementById('send-btn-2').disabled = false;

          addLog('âœ… ä¼šè¯åˆ›å»ºæˆåŠŸ', { conversation_id: state.conversationId });
        } else {
          throw new Error(data.msg || data.message || 'Unknown error');
        }
      } catch (error) {
        addLog('âŒ åˆ›å»ºä¼šè¯å¤±è´¥', { error: error.message }, 'error');
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const message = document.getElementById('message-input').value.trim();
      const apiKey = document.getElementById('api-key').value.trim();
      const botId = document.getElementById('bot-id').value.trim();
      const userId = document.getElementById('user-id').value.trim();
      const baseUrl = document.getElementById('base-url').value.trim();

      if (!state.conversationId) {
        alert('è¯·å…ˆåˆ›å»ºä¼šè¯');
        return;
      }

      if (!message) {
        alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
        return;
      }

      addLog('å‘é€æ¶ˆæ¯è¯·æ±‚', { conversation_id: state.conversationId, message });
      addMessage('user', message);
      document.getElementById('message-input').value = '';

      try {
        const payload = {
          bot_id: botId,
          user_id: userId,
          stream: false,
          auto_save_history: true,
          additional_messages: [{
            role: 'user',
            content: message,
            content_type: 'text'
          }]
        };

        const url = `${baseUrl}/v3/chat?conversation_id=${state.conversationId}`;
        addLog('COZEèŠå¤©åŸå§‹è¯·æ±‚', payload, 'coze-request', url);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        addLog('COZEèŠå¤©åŸå§‹å“åº”', data, 'coze-response');

        console.log('ğŸ” [è°ƒè¯•] COZEå“åº”ç»“æ„:', data);
        console.log('ğŸ” [è°ƒè¯•] response.ok:', response.ok);
        console.log('ğŸ” [è°ƒè¯•] data.code:', data.code);
        console.log('ğŸ” [è°ƒè¯•] data.data:', data.data);
        console.log('ğŸ” [è°ƒè¯•] data.data?.id:', data.data?.id);

        // æ£€æŸ¥å“åº”æˆåŠŸï¼ˆCOZE APIè¿”å›code: 0è¡¨ç¤ºæˆåŠŸï¼‰
        if (response.ok && data.code === 0 && data.data) {
          // æå–chat_idï¼ˆåœ¨data.data.idä¸­ï¼‰
          state.chatId = data.data.id || '';
          document.getElementById('chat-id').textContent = state.chatId;

          addLog('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', { 
            chat_id: state.chatId,
            conversation_id: data.data.conversation_id 
          });

          // å¼€å§‹è½®è¯¢AIå›å¤
          if (state.chatId) {
            pollMessages(1);
          } else {
            addLog('âš ï¸ è­¦å‘Š: æœªè·å–åˆ°chat_id', { response: data }, 'error');
          }
        } else {
          const errorMsg = data.msg || data.message || 'Send failed';
          throw new Error(`COZE APIé”™è¯¯: ${errorMsg} (code: ${data.code})`);
        }
      } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¼‚å¸¸:', error);
        addLog('âŒ å‘é€æ¶ˆæ¯å¤±è´¥', { 
          error: error.message,
          stack: error.stack 
        }, 'error');
      }
    }

    // è½®è¯¢æ¶ˆæ¯
    async function pollMessages(attempt) {
      if (attempt > MAX_POLL_ATTEMPTS) {
        addLog('â±ï¸ è½®è¯¢è¶…æ—¶', { attempts: attempt });
        hidePollingStatus();
        return;
      }

      showPollingStatus(attempt);
      state.isPolling = true;
      state.pollingAttempts = attempt;

      addLog('è½®è¯¢æ¶ˆæ¯è¯·æ±‚', { conversation_id: state.conversationId, chat_id: state.chatId, attempt });

      try {
        // å…ˆæ£€æŸ¥chat statusï¼ˆæµå¼è¾“å‡ºé—®é¢˜ä¿®å¤ï¼‰
        const apiKey = document.getElementById('api-key').value.trim();
        const baseUrl = document.getElementById('base-url').value.trim();
        const retrieveUrl = `${baseUrl}/v1/conversation/message/retrieve?conversation_id=${state.conversationId}&chat_id=${state.chatId}`;
        
        const retrieveResponse = await fetch(retrieveUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
          }
        });
        
        const retrieveData = await retrieveResponse.json();
        console.log('ğŸ” [Chat Status] æ£€æŸ¥chatçŠ¶æ€:', retrieveData);
        
        // å¦‚æœchatè¿˜åœ¨è¿›è¡Œä¸­ï¼Œç»§ç»­ç­‰å¾…
        if (retrieveData.data?.status === 'in_progress' || retrieveData.data?.status === 'created') {
          console.log('â³ [Chat Status] Chatè¿˜åœ¨è¿›è¡Œä¸­ï¼ŒçŠ¶æ€:', retrieveData.data?.status);
          if (attempt < MAX_POLL_ATTEMPTS) {
            state.pollingTimeout = setTimeout(() => pollMessages(attempt + 1), POLL_INTERVAL_MS);
          } else {
            addLog('â±ï¸ è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œåœæ­¢è½®è¯¢', { attempts: attempt });
            hidePollingStatus();
          }
          return;
        }
        
        // Chatå·²å®Œæˆï¼Œè·å–å®Œæ•´æ¶ˆæ¯
        console.log('âœ… [Chat Status] Chatå·²å®Œæˆï¼ŒçŠ¶æ€:', retrieveData.data?.status);
        
        // ä½¿ç”¨åç«¯ä»£ç†APIè·å–å®Œæ•´æ¶ˆæ¯
        const url = '/api/coze/messages';
        const payload = {
          conversation_id: state.conversationId,
          chat_id: state.chatId,
          limit: 20,
          order: 'desc'
        };

        addLog('COZEè½®è¯¢åŸå§‹è¯·æ±‚', payload, 'coze-request', url);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        addLog('COZEè½®è¯¢åŸå§‹å“åº”', data, 'coze-response');

        console.log('ğŸ” [è½®è¯¢è°ƒè¯•] å“åº”:', data);
        console.log('ğŸ” [è½®è¯¢è°ƒè¯•] data.success:', data.success);
        console.log('ğŸ” [è½®è¯¢è°ƒè¯•] data.data:', data.data);
        console.log('ğŸ” [è½®è¯¢è°ƒè¯•] data.data.messages:', data.data?.messages);
        
        // åç«¯APIè¿”å›æ ¼å¼: { success: true, data: { messages: [...] } }
        if (response.ok && data.success && data.data?.messages) {
          const messages = data.data.messages;
          
          console.log('ğŸ” [è½®è¯¢è°ƒè¯•] æå–çš„æ¶ˆæ¯æ•°ç»„:', messages);
          console.log('ğŸ” [è½®è¯¢è°ƒè¯•] æ¶ˆæ¯æ•°é‡:', messages.length);
          
          if (messages.length > 0) {
            console.log('ğŸ” [è½®è¯¢è°ƒè¯•] æ”¶åˆ°æ¶ˆæ¯æ•°é‡:', messages.length);
            
            // åç«¯å·²ç»è¿‡æ»¤è¿‡æ¶ˆæ¯ï¼Œç›´æ¥æŸ¥æ‰¾AIå›å¤
            const aiMessage = messages.find(m => {
              console.log('ğŸ” [è½®è¯¢è°ƒè¯•] æ£€æŸ¥æ¶ˆæ¯:', { 
                role: m.role, 
                type: m.type, 
                content: m.content?.substring(0, 50) 
              });
              
              return m.role === 'assistant' && m.content && m.content.trim();
            });

            if (aiMessage) {
              addMessage('assistant', aiMessage.content);
              addLog('ğŸ¤– æ”¶åˆ° AI å›å¤', { 
                content: aiMessage.content.substring(0, 100), 
                type: aiMessage.type,
                attempts: attempt 
              });
              hidePollingStatus();
              return;
            } else {
              console.log('â³ [è½®è¯¢è°ƒè¯•] æœªæ‰¾åˆ°æœ‰æ•ˆçš„AIå›å¤ï¼Œç»§ç»­è½®è¯¢...');
            }
          } else {
            console.log('â³ [è½®è¯¢è°ƒè¯•] æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼ŒAIå¯èƒ½è¿˜åœ¨ç”Ÿæˆï¼Œç»§ç»­è½®è¯¢...');
          }
        } else {
          console.log('âŒ [è½®è¯¢è°ƒè¯•] APIè¿”å›é”™è¯¯æˆ–æ— æ¶ˆæ¯:', data);
        }

        // ç»§ç»­è½®è¯¢
        if (attempt < MAX_POLL_ATTEMPTS) {
          state.pollingTimeout = setTimeout(() => pollMessages(attempt + 1), POLL_INTERVAL_MS);
        } else {
          addLog('â±ï¸ è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œåœæ­¢è½®è¯¢', { attempts: attempt });
          hidePollingStatus();
        }
      } catch (error) {
        console.error('âŒ è½®è¯¢å¼‚å¸¸:', error);
        addLog('âŒ è½®è¯¢æ¶ˆæ¯å¤±è´¥', { 
          error: error.message, 
          attempts: attempt 
        }, 'error');
        
        if (attempt < MAX_POLL_ATTEMPTS) {
          state.pollingTimeout = setTimeout(() => pollMessages(attempt + 1), POLL_INTERVAL_MS);
        } else {
          hidePollingStatus();
        }
      }
    }

    function showPollingStatus(attempt) {
      const status = document.getElementById('polling-status');
      status.textContent = `è½®è¯¢ä¸­ (${attempt}/${MAX_POLL_ATTEMPTS}ï¼Œæ¯3ç§’)`;
      status.style.display = 'inline-block';
    }

    function hidePollingStatus() {
      state.isPolling = false;
      document.getElementById('polling-status').style.display = 'none';
      if (state.pollingTimeout) {
        clearTimeout(state.pollingTimeout);
        state.pollingTimeout = null;
      }
    }

    // åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰
    async function loadTestData() {
      addLog('åŠ è½½æµ‹è¯•æ•°æ®', 'å¼€å§‹åŠ è½½è§’è‰²å’Œäº¤äº’æ¨¡å¼æ•°æ®');
      // è¿™é‡Œå¯ä»¥å®ç°åŠ è½½é±¼æ•°æ®å’Œäº¤äº’æ¨¡å¼çš„é€»è¾‘
      // ç›®å‰å…ˆæ˜¾ç¤ºå ä½ç¬¦
      document.getElementById('stats-characters').textContent = '-';
      document.getElementById('stats-modes').textContent = '-';
    }
  </script>
</body>
</html>

