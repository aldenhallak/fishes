# ğŸš¨ Hasura æ•°æ®åº“è¿ç§»æ­¥éª¤æŒ‡å—

## âš ï¸ é‡è¦æç¤º

ç”±äº Hasura GraphQL å¼•æ“åœ¨å…ƒæ•°æ®å±‚ç»´æŠ¤è¡¨å…³ç³»ï¼Œå¿…é¡»å…ˆåœ¨ Hasura æ§åˆ¶å°ä¸­æ‰‹åŠ¨è§£é™¤è¿™äº›å…³ç³»ï¼Œæ‰èƒ½æ‰§è¡Œ SQL è¿ç§»è„šæœ¬ã€‚

---

## ğŸ“‹ å®Œæ•´è¿ç§»æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½æ•°æ®åº“ï¼ˆ5åˆ†é’Ÿï¼‰â­ å¿…åšï¼

```bash
# PostgreSQL å¤‡ä»½å‘½ä»¤
pg_dump -h your-host -U your-user -d your-database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### ç¬¬äºŒæ­¥ï¼šåœ¨ Hasura æ§åˆ¶å°å–æ¶ˆè·Ÿè¸ªï¼ˆ3åˆ†é’Ÿï¼‰

æ‰“å¼€ Hasura Console â†’ **Data** æ ‡ç­¾é¡µ

#### 2.1 å–æ¶ˆè·Ÿè¸ª battle_log è¡¨

1. ç‚¹å‡»å·¦ä¾§ **battle_log** è¡¨
2. ç‚¹å‡» **Modify** æ ‡ç­¾
3. æ»šåŠ¨åˆ°åº•éƒ¨
4. ç‚¹å‡» **"Untrack Table"** æŒ‰é’®
5. ç¡®è®¤æ“ä½œ

#### 2.2 å–æ¶ˆè·Ÿè¸ª battle_config è¡¨

1. ç‚¹å‡»å·¦ä¾§ **battle_config** è¡¨
2. ç‚¹å‡» **Modify** æ ‡ç­¾
3. æ»šåŠ¨åˆ°åº•éƒ¨
4. ç‚¹å‡» **"Untrack Table"** æŒ‰é’®
5. ç¡®è®¤æ“ä½œ

#### 2.3 å–æ¶ˆè·Ÿè¸ª user_fish_summary è§†å›¾

1. ç‚¹å‡»å·¦ä¾§ **user_fish_summary** è§†å›¾
2. ç‚¹å‡» **Modify** æ ‡ç­¾
3. æ»šåŠ¨åˆ°åº•éƒ¨
4. ç‚¹å‡» **"Untrack View"** æŒ‰é’®
5. ç¡®è®¤æ“ä½œ

#### 2.4 åˆ é™¤ fish è¡¨çš„æˆ˜æ–—å…³ç³»

1. ç‚¹å‡»å·¦ä¾§ **fish** è¡¨
2. ç‚¹å‡» **Relationships** æ ‡ç­¾
3. æ‰¾åˆ° **battle_logs** å…³ç³»
   - ç‚¹å‡»å³ä¾§çš„ **"ç¼–è¾‘"** å›¾æ ‡
   - ç‚¹å‡» **"Delete"** æŒ‰é’®
   - ç¡®è®¤åˆ é™¤
4. æ‰¾åˆ° **battleLogsByDefenderId** å…³ç³»
   - ç‚¹å‡»å³ä¾§çš„ **"ç¼–è¾‘"** å›¾æ ‡
   - ç‚¹å‡» **"Delete"** æŒ‰é’®
   - ç¡®è®¤åˆ é™¤

âœ… **éªŒè¯ï¼š** åœ¨ fish è¡¨çš„ Relationships æ ‡ç­¾ä¸­ï¼Œä¸åº”å†çœ‹åˆ°ä»»ä½• battle ç›¸å…³çš„å…³ç³»ã€‚

---

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œ SQL è¿ç§»è„šæœ¬ï¼ˆ2åˆ†é’Ÿï¼‰

#### æ–¹æ³• Aï¼šåœ¨ Hasura æ§åˆ¶å°æ‰§è¡Œ

1. åœ¨ Hasura Console â†’ **Data** â†’ **SQL** æ ‡ç­¾
2. å¤åˆ¶ `scripts/migrate-complete-community-system.sql` çš„å…¨éƒ¨å†…å®¹
3. ç²˜è´´åˆ° SQL ç¼–è¾‘å™¨
4. **å–æ¶ˆå‹¾é€‰** "Track this" é€‰é¡¹ï¼ˆæˆ‘ä»¬ä¼šåœ¨ç¬¬å››æ­¥æ‰‹åŠ¨ trackï¼‰
5. ç‚¹å‡» **"Run!"** æŒ‰é’®
6. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆåº”è¯¥çœ‹åˆ°æˆåŠŸæ¶ˆæ¯ï¼‰

#### æ–¹æ³• Bï¼šä½¿ç”¨ psql å‘½ä»¤è¡Œ

```bash
psql -h your-host -U your-user -d your-database -f scripts/migrate-complete-community-system.sql
```

âœ… **é¢„æœŸè¾“å‡ºï¼š**
```
ALTER TABLE
ALTER TABLE
CREATE INDEX
...
================================================================
ğŸ‰ Community Chat System Migration Completed Successfully!
================================================================
```

---

### ç¬¬å››æ­¥ï¼šåœ¨ Hasura ä¸­è·Ÿè¸ªæ–°è¡¨ï¼ˆ2åˆ†é’Ÿï¼‰

è¿”å› Hasura Console â†’ **Data** æ ‡ç­¾é¡µ

#### 4.1 è·Ÿè¸ªæ–°è¡¨

åœ¨å·¦ä¾§ "Untracked tables or views" éƒ¨åˆ†ï¼Œç‚¹å‡» **"Track"** æŒ‰é’®ï¼š

1. âœ… **community_chat_sessions** - ç¤¾åŒºèŠå¤©ä¼šè¯è¡¨
2. âœ… **user_subscriptions** - ç”¨æˆ·è®¢é˜…è¡¨
3. âœ… **recent_chat_sessions** - æœ€è¿‘èŠå¤©ä¼šè¯è§†å›¾ï¼ˆå¦‚æœæ˜¾ç¤ºï¼‰

#### 4.2 è®¾ç½®è¡¨æƒé™

å¯¹äºæ¯ä¸ªæ–°è¡¨ï¼Œç‚¹å‡»è¡¨å â†’ **Permissions** æ ‡ç­¾ï¼š

**community_chat_sessions:**
- **Select**: å…è®¸æ‰€æœ‰ç”¨æˆ·æŸ¥çœ‹ï¼ˆæˆ–æ ¹æ®éœ€è¦é™åˆ¶ï¼‰
  ```json
  {
    "created_at": {
      "_gte": "now() - interval '7 days'"
    }
  }
  ```
- **Insert**: ä»…é™æœåŠ¡ç«¯ï¼ˆä¸å…è®¸å®¢æˆ·ç«¯ç›´æ¥æ’å…¥ï¼‰
- **Update**: ä¸å…è®¸
- **Delete**: ä¸å…è®¸

**user_subscriptions:**
- **Select**: ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢é˜…
  ```json
  {
    "user_id": {
      "_eq": "X-Hasura-User-Id"
    }
  }
  ```
- **Insert**: ä»…é™æœåŠ¡ç«¯
- **Update**: ä»…é™æœåŠ¡ç«¯
- **Delete**: ä¸å…è®¸

---

### ç¬¬äº”æ­¥ï¼šéªŒè¯è¿ç§»ï¼ˆ3åˆ†é’Ÿï¼‰

#### 5.1 æ£€æŸ¥ fish è¡¨ç»“æ„

åœ¨ Hasura Console â†’ **Data** â†’ **fish** è¡¨ â†’ **Modify**ï¼š

âœ… åº”è¯¥çœ‹åˆ°æ–°å­—æ®µï¼š
- `fish_name` (varchar 50)
- `personality_type` (varchar 20)

âŒ ä¸åº”è¯¥çœ‹åˆ°æ—§å­—æ®µï¼š
- `talent`
- `level`
- `experience`
- `health`
- `max_health`
- `battle_power`
- `last_exp_update`
- `is_in_battle_mode`
- `position_row`
- `total_wins`
- `total_losses`

#### 5.2 æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨

åœ¨å·¦ä¾§è¡¨åˆ—è¡¨ä¸­ï¼š

âœ… åº”è¯¥çœ‹åˆ°ï¼š
- `community_chat_sessions`
- `user_subscriptions`
- `recent_chat_sessions` (è§†å›¾)

âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š
- `battle_log`
- `battle_config`
- `user_fish_summary` (æ—§è§†å›¾)

#### 5.3 æµ‹è¯• GraphQL æŸ¥è¯¢

åœ¨ Hasura Console â†’ **API** æ ‡ç­¾ï¼Œè¿è¡Œæµ‹è¯•æŸ¥è¯¢ï¼š

```graphql
query TestMigration {
  # æµ‹è¯•æ–°è¡¨
  community_chat_sessions(limit: 1) {
    id
    topic
    created_at
  }
  
  user_subscriptions(limit: 1) {
    user_id
    plan
    is_active
  }
  
  # æµ‹è¯• fish è¡¨æ–°å­—æ®µ
  fish(limit: 1) {
    id
    fish_name
    personality_type
    image_url
  }
}
```

âœ… **é¢„æœŸç»“æœï¼š** æŸ¥è¯¢æˆåŠŸè¿”å›ï¼Œæ²¡æœ‰é”™è¯¯ã€‚

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1: "cannot drop due to dependent objects"

**åŸå› ï¼š** æ²¡æœ‰å®Œæˆç¬¬äºŒæ­¥ï¼Œä»æœ‰ Hasura å…³ç³»ä¾èµ–ã€‚

**è§£å†³ï¼š**
1. å›åˆ°ç¬¬äºŒæ­¥ï¼Œç¡®ä¿æ‰€æœ‰ battle ç›¸å…³çš„è¡¨å’Œå…³ç³»éƒ½å·² untrack
2. åˆ·æ–° Hasura æ§åˆ¶å°
3. é‡æ–°æ‰§è¡Œè¿ç§»è„šæœ¬

### é—®é¢˜ 2: "column already exists"

**åŸå› ï¼š** éƒ¨åˆ†è„šæœ¬å·²æ‰§è¡Œè¿‡ã€‚

**è§£å†³ï¼š**
1. æ£€æŸ¥ fish è¡¨æ˜¯å¦å·²æœ‰ `fish_name` å’Œ `personality_type` å­—æ®µ
2. å¦‚æœæœ‰ï¼Œå¯ä»¥è·³è¿‡ PART 1ï¼Œä» PART 2 å¼€å§‹æ‰§è¡Œ
3. æˆ–è€…ä½¿ç”¨å¤‡ä»½æ¢å¤åé‡æ–°æ‰§è¡Œå®Œæ•´è„šæœ¬

### é—®é¢˜ 3: "table does not exist"

**åŸå› ï¼š** æˆ˜æ–—è¡¨å·²è¢«åˆ é™¤ã€‚

**è§£å†³ï¼š**
1. è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œç»§ç»­æ‰§è¡Œè„šæœ¬
2. SQL ä¸­ä½¿ç”¨äº† `IF EXISTS`ï¼Œåº”è¯¥ä¸ä¼šæŠ¥é”™

### é—®é¢˜ 4: GraphQL æŸ¥è¯¢æ˜¾ç¤ºæ—§å­—æ®µ

**åŸå› ï¼š** Hasura å…ƒæ•°æ®ç¼“å­˜æœªæ›´æ–°ã€‚

**è§£å†³ï¼š**
1. åœ¨ Hasura Console å³ä¸Šè§’ç‚¹å‡» **"Reload Metadata"**
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. åˆ·æ–°é¡µé¢

---

## âœ… è¿ç§»å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“å·²å¤‡ä»½
- [ ] ç¬¬äºŒæ­¥ï¼šæ‰€æœ‰ battle ç›¸å…³è¡¨å’Œå…³ç³»å·² untrack
- [ ] ç¬¬ä¸‰æ­¥ï¼šSQL è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] ç¬¬å››æ­¥ï¼šæ–°è¡¨å·² track å¹¶è®¾ç½®æƒé™
- [ ] ç¬¬äº”æ­¥ï¼šéªŒè¯æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] GraphQL æŸ¥è¯¢æµ‹è¯•æˆåŠŸ
- [ ] fish è¡¨åªæ˜¾ç¤ºæ–°å­—æ®µï¼Œæ²¡æœ‰æ—§æˆ˜æ–—å­—æ®µ
- [ ] battle_log å’Œ battle_config è¡¨ä¸å†å­˜åœ¨

---

## ğŸ“ è¿ç§»åç»­æ­¥éª¤

å®Œæˆæ•°æ®åº“è¿ç§»åï¼š

1. **é…ç½®ç¯å¢ƒå˜é‡** - å‚è€ƒ `ENV_SETUP_GUIDE.md`
2. **æµ‹è¯• COZE AI é›†æˆ** - å‚è€ƒ `QUICK_START.md`
3. **éƒ¨ç½²å‰ç«¯ä»£ç ** - ç¡®ä¿æ–°çš„ JS æ–‡ä»¶å·²éƒ¨ç½²
4. **ç›‘æ§æ—¥å¿—** - è§‚å¯Ÿè¿ç§»åç³»ç»Ÿæ˜¯å¦æ­£å¸¸è¿è¡Œ

---

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ PostgreSQL æ—¥å¿—ï¼š`tail -f /var/log/postgresql/postgresql.log`
2. æ£€æŸ¥ Hasura æ—¥å¿—ï¼šåœ¨ Hasura Cloud æˆ–æœ¬åœ°æŸ¥çœ‹æ—¥å¿—
3. ä½¿ç”¨å¤‡ä»½æ¢å¤ï¼š`psql -h your-host -U your-user -d your-database < backup.sql`
4. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬

---

**æœ€åæ›´æ–°ï¼š** 2025-11-06  
**ä½œè€…ï¼š** Fish Art Development Team

