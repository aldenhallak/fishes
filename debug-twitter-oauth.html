<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter OAuth è¯Šæ–­</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      background: #252526;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 3px solid #007acc;
    }
    .title {
      color: #4ec9b0;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .param {
      color: #ce9178;
      margin: 5px 0;
      font-size: 14px;
    }
    .value {
      color: #9cdcfe;
    }
    .error {
      color: #f48771;
      border-left-color: #f48771;
    }
    .success {
      color: #4ec9b0;
      border-left-color: #4ec9b0;
    }
    .warning {
      color: #dcdcaa;
      border-left-color: #dcdcaa;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #005a9e;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
      font-size: 12px;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status-ok { background: #4ec9b0; }
    .status-error { background: #f48771; }
    .status-warning { background: #dcdcaa; }
  </style>
</head>
<body>
  <h1>ğŸ” Twitter OAuth è¯Šæ–­å·¥å…·</h1>
  
  <div class="section">
    <div class="title">ğŸ“‹ Supabase é…ç½®</div>
    <div id="supabaseConfig">åŠ è½½ä¸­...</div>
  </div>

  <div class="section">
    <div class="title">ğŸ”‘ Twitter Provider çŠ¶æ€</div>
    <div id="twitterProviderStatus">æ£€æŸ¥ä¸­...</div>
  </div>

  <div class="section">
    <div class="title">ğŸ§ª æµ‹è¯• Twitter OAuth</div>
    <button id="testTwitterBtn" disabled>æµ‹è¯• Twitter ç™»å½•</button>
    <button id="testDiscordBtn" disabled>æµ‹è¯• Discord ç™»å½•ï¼ˆå¯¹æ¯”ï¼‰</button>
    <div id="testResult" style="margin-top: 10px;"></div>
  </div>

  <div class="section">
    <div class="title">ğŸ“Š è¯Šæ–­ç»“æœ</div>
    <div id="diagnostics"></div>
  </div>

  <div class="section">
    <div class="title">ğŸ’¡ å»ºè®®æ“ä½œ</div>
    <div id="suggestions"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let supabaseClient = null;

    // ç›´æ¥åŠ è½½ Supabase é…ç½®
    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/config-api?action=supabase');
        if (response.ok) {
          const config = await response.json();
          window.SUPABASE_URL = config.url;
          window.SUPABASE_ANON_KEY = config.anonKey;
          console.log('âœ… Supabase config loaded');
          return true;
        }
        throw new Error('Failed to load config');
      } catch (error) {
        console.error('âŒ Config load failed:', error);
        return false;
      }
    }

    // åˆå§‹åŒ–
    (async function init() {
      const configLoaded = await loadSupabaseConfig();
      if (!configLoaded) {
        document.getElementById('supabaseConfig').innerHTML = 
          '<div class="param error">âŒ æ— æ³•åŠ è½½ Supabase é…ç½®</div>';
        return;
      }
      try {
        // æ˜¾ç¤ºé…ç½®
        const configDiv = document.getElementById('supabaseConfig');
        const url = window.SUPABASE_URL;
        const hasKey = window.SUPABASE_ANON_KEY && window.SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY';
        
        configDiv.innerHTML = `
          <div class="param">
            <span class="status-indicator ${url && url !== 'YOUR_SUPABASE_URL' ? 'status-ok' : 'status-error'}"></span>
            Supabase URL: <span class="value">${url || '(æœªé…ç½®)'}</span>
          </div>
          <div class="param">
            <span class="status-indicator ${hasKey ? 'status-ok' : 'status-error'}"></span>
            Anon Key: <span class="value">${hasKey ? window.SUPABASE_ANON_KEY.substring(0, 20) + '...' : '(æœªé…ç½®)'}</span>
          </div>
        `;

        if (!url || url === 'YOUR_SUPABASE_URL' || !hasKey) {
          document.getElementById('twitterProviderStatus').innerHTML = 
            '<div class="param error">âŒ Supabase é…ç½®æ— æ•ˆï¼Œæ— æ³•æµ‹è¯•</div>';
          return;
        }

        // åˆå§‹åŒ– Supabase
        const { createClient } = supabase;
        supabaseClient = createClient(url, window.SUPABASE_ANON_KEY);

        // æ£€æŸ¥ Twitter Provider
        await checkTwitterProvider();

        // å¯ç”¨æµ‹è¯•æŒ‰é’®
        document.getElementById('testTwitterBtn').disabled = false;
        document.getElementById('testDiscordBtn').disabled = false;

      } catch (error) {
        document.getElementById('supabaseConfig').innerHTML = 
          `<div class="param error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
      }
    })();

    async function checkTwitterProvider() {
      const statusDiv = document.getElementById('twitterProviderStatus');
      
      try {
        // å°è¯•è·å– OAuth providersï¼ˆè¿™ä¸ªAPIå¯èƒ½ä¸å­˜åœ¨ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°è¯•ï¼‰
        statusDiv.innerHTML = '<div class="param">â³ æ£€æŸ¥ Twitter Provider...</div>';

        // å®é™…ä¸Šï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ£€æŸ¥ provider æ˜¯å¦å¯ç”¨
        // ä½†æˆ‘ä»¬å¯ä»¥å°è¯•å‘èµ· OAuth è¯·æ±‚æ¥æµ‹è¯•
        statusDiv.innerHTML = `
          <div class="param">
            <span class="status-indicator status-warning"></span>
            æ— æ³•ç›´æ¥æ£€æŸ¥ Provider çŠ¶æ€
          </div>
          <div class="param">ğŸ’¡ è¯·åœ¨ Supabase Dashboard ä¸­ç¡®è®¤ Twitter Provider å·²å¯ç”¨</div>
          <div class="param">ğŸ“ Authentication â†’ Providers â†’ Twitter</div>
        `;

      } catch (error) {
        statusDiv.innerHTML = `<div class="param error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
      }
    }

    document.getElementById('testTwitterBtn').onclick = async () => {
      await testOAuth('twitter');
    };

    document.getElementById('testDiscordBtn').onclick = async () => {
      await testOAuth('discord');
    };

    async function testOAuth(provider) {
      const resultDiv = document.getElementById('testResult');
      const diagnosticsDiv = document.getElementById('diagnostics');
      const suggestionsDiv = document.getElementById('suggestions');

      resultDiv.innerHTML = `<div class="param">â³ æ­£åœ¨æµ‹è¯• ${provider} OAuth...</div>`;
      diagnosticsDiv.innerHTML = '';
      suggestionsDiv.innerHTML = '';

      try {
        console.log(`ğŸ§ª Testing ${provider} OAuth...`);
        console.log('Supabase URL:', window.SUPABASE_URL);
        console.log('Provider:', provider);

        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: provider,
          options: {
            redirectTo: `${window.location.origin}/debug-oauth-callback.html`,
            skipBrowserRedirect: true  // ä¸è‡ªåŠ¨è·³è½¬ï¼Œåªè·å– URL
          }
        });

        console.log('OAuth response:', { data, error });

        if (error) {
          throw error;
        }

        if (data && data.url) {
          resultDiv.innerHTML = `
            <div class="param success">âœ… OAuth URL ç”ŸæˆæˆåŠŸ</div>
            <div class="param">Provider: <span class="value">${provider}</span></div>
            <div class="param">OAuth URL: <span class="value">${data.url.substring(0, 100)}...</span></div>
          `;

          diagnosticsDiv.innerHTML = `
            <div class="param success">
              <span class="status-indicator status-ok"></span>
              ${provider} Provider é…ç½®æ­£ç¡®
            </div>
            <div class="param">âœ… Supabase å¯ä»¥ç”Ÿæˆ OAuth URL</div>
            <div class="param">âœ… Provider å·²åœ¨ Supabase Dashboard ä¸­å¯ç”¨</div>
          `;

          suggestionsDiv.innerHTML = `
            <div class="param success">âœ… ${provider} OAuth é…ç½®æ­£å¸¸</div>
            <div class="param">ä½ å¯ä»¥ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•å®Œæ•´çš„ç™»å½•æµç¨‹ï¼š</div>
            <button onclick="window.location.href='${data.url}'">å‰å¾€ ${provider} æˆæƒé¡µé¢</button>
          `;
        } else {
          throw new Error('æœªè¿”å› OAuth URL');
        }

      } catch (error) {
        console.error(`âŒ ${provider} OAuth test failed:`, error);

        resultDiv.innerHTML = `<div class="param error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;

        // åˆ†æé”™è¯¯
        let diagnosis = '';
        let suggestions = '';

        if (error.message.includes('404') || error.message.includes('Not Found')) {
          diagnosis = `
            <div class="param error">
              <span class="status-indicator status-error"></span>
              ${provider} Provider æœªå¯ç”¨æˆ–é…ç½®é”™è¯¯
            </div>
            <div class="param">âŒ Supabase è¿”å› 404 é”™è¯¯</div>
            <div class="param">âŒ è¿™é€šå¸¸æ„å‘³ç€ Provider æœªåœ¨ Dashboard ä¸­å¯ç”¨</div>
          `;

          suggestions = `
            <div class="param error">âŒ ${provider} Provider æœªæ­£ç¡®é…ç½®</div>
            <div class="param">è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ£€æŸ¥ï¼š</div>
            <div class="param">1. è®¿é—® Supabase Dashboard</div>
            <div class="param">2. é€‰æ‹©é¡¹ç›®ï¼šxxeplxorhecwwhtrakzw</div>
            <div class="param">3. Authentication â†’ Providers â†’ ${provider}</div>
            <div class="param">4. ç¡®è®¤ ${provider} Enabled å¼€å…³å·²æ‰“å¼€</div>
            <div class="param">5. ç¡®è®¤ Client ID å’Œ Client Secret å·²å¡«å†™</div>
            <div class="param">6. ç‚¹å‡» Save ä¿å­˜</div>
            <div class="param">7. ç­‰å¾… 1-2 åˆ†é’Ÿåé‡è¯•</div>
          `;
        } else if (error.message.includes('Invalid') || error.message.includes('invalid')) {
          diagnosis = `
            <div class="param error">
              <span class="status-indicator status-error"></span>
              ${provider} Provider é…ç½®æ— æ•ˆ
            </div>
            <div class="param">âŒ Client ID æˆ– Client Secret å¯èƒ½é”™è¯¯</div>
          `;

          suggestions = `
            <div class="param error">âŒ ${provider} Provider å‡­è¯å¯èƒ½é”™è¯¯</div>
            <div class="param">è¯·é‡æ–°é…ç½®ï¼š</div>
            <div class="param">1. è®¿é—® ${provider === 'twitter' ? 'Twitter Developer Portal' : 'Discord Developer Portal'}</div>
            <div class="param">2. é‡æ–°ç”Ÿæˆ Client Secret</div>
            <div class="param">3. å¤åˆ¶æ–°çš„ Client ID å’Œ Secret</div>
            <div class="param">4. åœ¨ Supabase Dashboard ä¸­æ›´æ–°</div>
          `;
        } else {
          diagnosis = `
            <div class="param error">
              <span class="status-indicator status-error"></span>
              æœªçŸ¥é”™è¯¯
            </div>
            <div class="param">é”™è¯¯ä¿¡æ¯: ${error.message}</div>
          `;

          suggestions = `
            <div class="param">è¯·æ£€æŸ¥ï¼š</div>
            <div class="param">1. Supabase Dashboard ä¸­ ${provider} Provider æ˜¯å¦å¯ç”¨</div>
            <div class="param">2. Client ID å’Œ Client Secret æ˜¯å¦æ­£ç¡®</div>
            <div class="param">3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</div>
            <div class="param">4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ›´å¤šé”™è¯¯ä¿¡æ¯</div>
          `;
        }

        diagnosticsDiv.innerHTML = diagnosis;
        suggestionsDiv.innerHTML = suggestions;
      }
    }
  </script>
</body>
</html>
