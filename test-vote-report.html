<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ•ç¥¨ä¸¾æŠ¥æµ‹è¯• - Fish Art</title>
  <link rel="stylesheet" href="src/css/common.css">
  <style>
    body {
      background: #f7fafc;
      min-height: 100vh;
      padding: 2rem;
    }

    .test-container {
      max-w: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 2rem;
    }

    .test-header {
      margin-bottom: 2rem;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 1rem;
    }

    .test-header h1 {
      font-size: 2rem;
      color: #1a202c;
      margin-bottom: 0.5rem;
    }

    .test-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #718096;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2d3748;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .vote-buttons {
      display: flex;
      gap: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-upvote {
      background: #48bb78;
      color: white;
      flex: 1;
    }

    .btn-upvote:hover {
      background: #38a169;
    }

    .btn-downvote {
      background: #f56565;
      color: white;
      flex: 1;
    }

    .btn-downvote:hover {
      background: #e53e3e;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-primary:disabled,
    .btn-upvote:disabled,
    .btn-downvote:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }

    .results-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #e2e8f0;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 1rem;
    }

    .results-container {
      max-height: 500px;
      overflow-y: auto;
    }

    .result-item {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .result-item.success {
      background: #f0fff4;
      border-color: #9ae6b4;
    }

    .result-item.error {
      background: #fff5f5;
      border-color: #fc8181;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .result-item.success .status-badge {
      background: #9ae6b4;
      color: #22543d;
    }

    .result-item.error .status-badge {
      background: #fc8181;
      color: #742a2a;
    }

    .json-result {
      background: #1a202c;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      margin-top: 2rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .info-box {
      background: #edf2f7;
      border-left: 4px solid #667eea;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 2rem;
    }

    .info-box h3 {
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .info-box ul {
      list-style: none;
      padding-left: 0;
    }

    .info-box li {
      color: #4a5568;
      padding: 0.25rem 0;
      font-size: 0.9rem;
    }

    .info-box li::before {
      content: "â€¢ ";
      color: #667eea;
      font-weight: bold;
      margin-right: 0.5rem;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.toast-success {
      background: #48bb78;
      color: white;
    }

    .toast.toast-error {
      background: #f56565;
      color: white;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>ğŸ‘ æŠ•ç¥¨ä¸¾æŠ¥æµ‹è¯•</h1>
      <p>æµ‹è¯•æŠ•ç¥¨ç³»ç»Ÿå’Œä¸¾æŠ¥åŠŸèƒ½</p>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="info-box">
      <h3>ğŸ’¡ æµ‹è¯•è¯´æ˜</h3>
      <ul>
        <li>âœ… å¼€å‘é˜¶æ®µæ— éœ€ç™»å½•å³å¯æµ‹è¯•</li>
        <li>æ¯ä¸ªç”¨æˆ·å¯¹åŒä¸€æ¡é±¼åªèƒ½æŠ•ä¸€æ¬¡ç¥¨</li>
        <li>å¯ä»¥åˆ‡æ¢æŠ•ç¥¨ç±»å‹ï¼ˆèµæˆ/åå¯¹ï¼‰</li>
        <li>ä¸¾æŠ¥éœ€è¦æä¾›åˆç†çš„ç†ç”±</li>
        <li>ä¸¾æŠ¥ç†ç”±åŒ…æ‹¬ï¼šä¸å½“å†…å®¹ã€ä½è´¨é‡ã€åƒåœ¾ä¿¡æ¯ã€ç‰ˆæƒé—®é¢˜ã€å…¶ä»–</li>
      </ul>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="test-tabs">
      <button class="tab active" data-tab="vote">æŠ•ç¥¨æµ‹è¯•</button>
      <button class="tab" data-tab="report">ä¸¾æŠ¥æµ‹è¯•</button>
    </div>

    <!-- æŠ•ç¥¨æµ‹è¯• -->
    <div class="tab-content active" id="vote">
      <form id="voteForm">
        <div class="form-group">
          <label for="voteFishId">é±¼ID *</label>
          <input type="text" id="voteFishId" required placeholder="è¾“å…¥è¦æŠ•ç¥¨çš„é±¼ID">
        </div>
        <div class="form-group">
          <label>æŠ•ç¥¨ç±»å‹</label>
          <div class="vote-buttons">
            <button type="button" class="btn btn-upvote" data-vote-type="upvote">
              ğŸ‘ èµæˆ (Upvote)
            </button>
            <button type="button" class="btn btn-downvote" data-vote-type="downvote">
              ğŸ‘ åå¯¹ (Downvote)
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- ä¸¾æŠ¥æµ‹è¯• -->
    <div class="tab-content" id="report">
      <form id="reportForm">
        <div class="form-group">
          <label for="reportFishId">é±¼ID *</label>
          <input type="text" id="reportFishId" required placeholder="è¾“å…¥è¦ä¸¾æŠ¥çš„é±¼ID">
        </div>
        <div class="form-group">
          <label for="reportReason">ä¸¾æŠ¥ç†ç”± *</label>
          <select id="reportReason" required>
            <option value="">è¯·é€‰æ‹©ä¸¾æŠ¥ç†ç”±</option>
            <option value="inappropriate">ä¸å½“å†…å®¹</option>
            <option value="low_quality">ä½è´¨é‡</option>
            <option value="spam">åƒåœ¾ä¿¡æ¯</option>
            <option value="copyright">ç‰ˆæƒé—®é¢˜</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label for="reportDetails">è¯¦ç»†è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="reportDetails" placeholder="è¯·æè¿°å…·ä½“çš„é—®é¢˜..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">æäº¤ä¸¾æŠ¥</button>
      </form>
    </div>

    <!-- ç»“æœå±•ç¤º -->
    <div class="results-section">
      <h2 class="section-title">æ“ä½œç»“æœ</h2>
      <div class="results-container" id="resultsContainer"></div>
    </div>

    <a href="test-center.html" class="back-link">â† è¿”å›æµ‹è¯•ä¸­å¿ƒ</a>
  </div>

  <!-- åŠ è½½ä¾èµ– -->
  <script src="public/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="src/js/supabase-init.js"></script>
  <script src="src/js/admin-auth.js"></script>
  <script src="src/js/test-utils.js"></script>
  
  <script>
    // ç®¡ç†å‘˜æƒé™æ£€æŸ¥
    (async function() {
      if (document.readyState === 'loading') {
        await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
      }
      if (!window.supabaseAuth) {
        await new Promise(resolve => {
          const checkInterval = setInterval(() => {
            if (window.supabaseAuth) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        });
      }
      await window.adminAuth.requireAdminAccess();
    })();
  </script>
  
  <script>
    // æ ‡ç­¾é¡µåˆ‡æ¢
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(tabId).classList.add('active');
      });
    });

    const resultsContainer = document.getElementById('resultsContainer');

    // æŠ•ç¥¨æŒ‰é’®å¤„ç†
    const voteButtons = document.querySelectorAll('.vote-buttons button');
    
    voteButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const fishId = document.getElementById('voteFishId').value;
        
        if (!fishId) {
          showToast('è¯·è¾“å…¥é±¼ID', 'error');
          return;
        }
        
        const voteType = button.dataset.voteType;
        
        // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
        voteButtons.forEach(btn => btn.disabled = true);
        setButtonLoading(button, true);
        
        const result = await apiCall(`${window.BACKEND_URL}/api/vote/vote`, {
          method: 'POST',
          body: {
            fishId,
            voteType
          }
        });
        
        // æ¢å¤æŒ‰é’®
        voteButtons.forEach(btn => btn.disabled = false);
        setButtonLoading(button, false);
        
        renderApiResult(result, resultsContainer);
        
        if (result.success) {
          showToast(`${voteType === 'upvote' ? 'èµæˆ' : 'åå¯¹'}æŠ•ç¥¨æˆåŠŸï¼`);
        } else {
          showToast('æŠ•ç¥¨å¤±è´¥', 'error');
        }
      });
    });

    // ä¸¾æŠ¥è¡¨å•å¤„ç†
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fishId = document.getElementById('reportFishId').value;
      const reason = document.getElementById('reportReason').value;
      const details = document.getElementById('reportDetails').value;
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(submitBtn, true);
      
      const result = await apiCall(`${window.BACKEND_URL}/api/report/submit`, {
        method: 'POST',
        body: {
          fishId,
          reason,
          details: details || undefined
        }
      });
      
      setButtonLoading(submitBtn, false);
      renderApiResult(result, resultsContainer);
      
      if (result.success) {
        showToast('ä¸¾æŠ¥æäº¤æˆåŠŸï¼');
        e.target.reset();
      } else {
        showToast('ä¸¾æŠ¥æäº¤å¤±è´¥', 'error');
      }
    });

    // å¼€å‘é˜¶æ®µï¼šè·³è¿‡ç™»å½•æ£€æŸ¥
    // (async () => {
    //   const isLoggedIn = await isUserLoggedIn();
    //   if (!isLoggedIn) {
    //     if (confirm('éœ€è¦ç™»å½•æ‰èƒ½æµ‹è¯•è¿™äº›åŠŸèƒ½ã€‚æ˜¯å¦å‰å¾€ç™»å½•é¡µé¢ï¼Ÿ')) {
    //       window.location.href = 'login.html';
    //     }
    //   }
    // })();
  </script>
</body>
</html>

