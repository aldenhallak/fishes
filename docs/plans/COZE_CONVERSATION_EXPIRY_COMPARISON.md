# Conversationè¿‡æœŸæ–¹æ¡ˆå¯¹æ¯”

## ğŸ“Š ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆAï¼šå®Œå…¨ä¸åˆ¤æ–­è¿‡æœŸ
**ç­–ç•¥**ï¼šä¸å¤„ç†è¿‡æœŸï¼Œç›´æ¥ä½¿ç”¨conversationId

#### ä»£ç ç¤ºä¾‹
```javascript
async function sendMessage(conversationId, message) {
    // ç›´æ¥è°ƒç”¨ï¼Œä¸æ£€æŸ¥è¿‡æœŸ
    return await cozeAPI.chat(conversationId, message);
}
```

#### ä¼˜ç¼ºç‚¹
| é¡¹ç›® | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| ä»£ç å¤æ‚åº¦ | â­â­â­â­â­ | æœ€ç®€å• |
| ç”¨æˆ·ä½“éªŒ | â­â­ | å¯èƒ½çœ‹åˆ°è«åé”™è¯¯ |
| æ•°æ®åº“å‹åŠ› | â­ | æ•°æ®æ— é™å¢é•¿ |
| ç»´æŠ¤æˆæœ¬ | â­â­â­â­ | ä½ |
| **æ¨èåº¦** | âŒ | ä¸æ¨è |

---

### æ–¹æ¡ˆBï¼šè¢«åŠ¨å¤„ç† + è‡ªåŠ¨é‡è¯•ï¼ˆâœ… æ¨èï¼‰
**ç­–ç•¥**ï¼šæ£€æµ‹Coze APIé”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•

#### ä»£ç ç¤ºä¾‹
```javascript
async function sendMessageWithAutoRenew(conversationId, message, userId, fishIds) {
    try {
        // ç›´æ¥è°ƒç”¨Coze API
        return await cozeAPI.chat(conversationId, message);
    } catch (error) {
        // æ£€æµ‹åˆ°è¿‡æœŸé”™è¯¯
        if (isConversationExpiredError(error)) {
            // æ ‡è®°æ—§çš„ä¸ºè¿‡æœŸ
            await expireConversation(conversationId);
            // åˆ›å»ºæ–°çš„
            const newConv = await createConversation(userId, fishIds);
            // é‡è¯•
            return await cozeAPI.chat(newConv.coze_conversation_id, message);
        }
        throw error;
    }
}
```

#### ä¼˜ç¼ºç‚¹
| é¡¹ç›® | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| ä»£ç å¤æ‚åº¦ | â­â­â­â­ | è¾ƒç®€å• |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­â­ | è‡ªåŠ¨å¤„ç†ï¼Œæ— æ„ŸçŸ¥ |
| æ•°æ®åº“å‹åŠ› | â­â­â­ | å¯é€‰æ¸…ç† |
| ç»´æŠ¤æˆæœ¬ | â­â­â­â­ | ä½ |
| **æ¨èåº¦** | âœ… | **å¼ºçƒˆæ¨è** |

#### ä¼˜åŠ¿
- âœ… ä»£ç ç®€å•ï¼Œæ˜“äºç†è§£
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼Œè‡ªåŠ¨å¤„ç†
- âœ… ä¸éœ€è¦å®šæœŸä»»åŠ¡
- âœ… ä¸éœ€è¦å‰ç«¯æ£€æŸ¥
- âœ… æ˜“äºæµ‹è¯•

#### å®æ–½è¦ç‚¹
1. å‡†ç¡®è¯†åˆ«Coze APIçš„è¿‡æœŸé”™è¯¯
2. ä¿ç•™expires_atå­—æ®µï¼ˆä¸ºå°†æ¥æ‰©å±•ï¼‰
3. è®°å½•è¿‡æœŸäº‹ä»¶æ—¥å¿—
4. å¯é€‰ï¼šåç»­æ·»åŠ å®šæœŸæ¸…ç†

---

### æ–¹æ¡ˆCï¼šä¸»åŠ¨æ£€æŸ¥ + å®šæœŸæ¸…ç†
**ç­–ç•¥**ï¼šä¸»åŠ¨æ£€æŸ¥expires_atï¼Œå®šæœŸæ¸…ç†

#### ä»£ç ç¤ºä¾‹
```javascript
async function sendMessage(conversationId, message) {
    // 1. å…ˆæ£€æŸ¥æœ¬åœ°æ•°æ®åº“
    const conv = await getConversation(conversationId);
    
    if (conv.expires_at < new Date()) {
        throw new Error('Conversationå·²è¿‡æœŸ');
    }
    
    // 2. è°ƒç”¨Coze API
    return await cozeAPI.chat(conversationId, message);
}

// å®šæœŸæ¸…ç†ä»»åŠ¡
async function cleanupExpiredConversations() {
    await db.query(`
        UPDATE conversations 
        SET status = 'expired' 
        WHERE expires_at < NOW() AND status = 'active'
    `);
}
```

#### ä¼˜ç¼ºç‚¹
| é¡¹ç›® | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| ä»£ç å¤æ‚åº¦ | â­â­ | è¾ƒå¤æ‚ |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­â­ | æœ€å¥½ |
| æ•°æ®åº“å‹åŠ› | â­â­â­â­â­ | æœ€ä½ |
| ç»´æŠ¤æˆæœ¬ | â­â­ | é«˜ |
| **æ¨èåº¦** | âš ï¸ | å¯é€‰ |

#### ä¼˜åŠ¿
- âœ… æå‰å‘ç°è¿‡æœŸï¼Œé¿å…æ— æ•ˆAPIè°ƒç”¨
- âœ… æ•°æ®åº“å®šæœŸæ¸…ç†ï¼Œæ€§èƒ½æœ€ä¼˜
- âœ… å¯æ§çš„ç”Ÿå‘½å‘¨æœŸ

#### åŠ£åŠ¿
- âŒ ä»£ç å¤æ‚åº¦é«˜
- âŒ éœ€è¦å®šæœŸä»»åŠ¡
- âŒ éœ€è¦å‰ç«¯é…åˆ
- âŒ æµ‹è¯•åœºæ™¯æ›´å¤š

---

## ğŸ¯ å†³ç­–çŸ©é˜µ

### åœºæ™¯1ï¼šå¿«é€Ÿä¸Šçº¿ï¼ˆMVPï¼‰
**æ¨è**ï¼šæ–¹æ¡ˆB
- ä»£ç ç®€å•ï¼Œå¼€å‘å¿«
- ç”¨æˆ·ä½“éªŒå¥½
- é£é™©ä½

### åœºæ™¯2ï¼šé«˜å¹¶å‘ç³»ç»Ÿ
**æ¨è**ï¼šæ–¹æ¡ˆB â†’ æ–¹æ¡ˆC
- å…ˆç”¨æ–¹æ¡ˆBå¿«é€Ÿä¸Šçº¿
- è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡
- å¿…è¦æ—¶å‡çº§åˆ°æ–¹æ¡ˆC

### åœºæ™¯3ï¼šä½æµé‡ç³»ç»Ÿ
**æ¨è**ï¼šæ–¹æ¡ˆB
- æ–¹æ¡ˆBå·²è¶³å¤Ÿ
- æ— éœ€è¿‡åº¦è®¾è®¡

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### APIè°ƒç”¨æ¬¡æ•°
| æ–¹æ¡ˆ | æ­£å¸¸æƒ…å†µ | è¿‡æœŸæƒ…å†µ |
|------|---------|---------|
| æ–¹æ¡ˆA | 1æ¬¡ | 1æ¬¡ï¼ˆå¤±è´¥ï¼‰ |
| æ–¹æ¡ˆB | 1æ¬¡ | 2æ¬¡ï¼ˆé‡è¯•ï¼‰ |
| æ–¹æ¡ˆC | 1æ¬¡ | 1æ¬¡ï¼ˆæå‰æ‹¦æˆªï¼‰ |

### æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
| æ–¹æ¡ˆ | æ¯æ¬¡æ¶ˆæ¯ |
|------|---------|
| æ–¹æ¡ˆA | 0æ¬¡ |
| æ–¹æ¡ˆB | 1æ¬¡ï¼ˆæ›´æ–°ï¼‰ |
| æ–¹æ¡ˆC | 2æ¬¡ï¼ˆæŸ¥è¯¢+æ›´æ–°ï¼‰ |

### å“åº”æ—¶é—´
| æ–¹æ¡ˆ | æ­£å¸¸æƒ…å†µ | è¿‡æœŸæƒ…å†µ |
|------|---------|---------|
| æ–¹æ¡ˆA | ~1s | å¤±è´¥ |
| æ–¹æ¡ˆB | ~1s | ~2sï¼ˆé‡è¯•ï¼‰ |
| æ–¹æ¡ˆC | ~1s | ~0.1sï¼ˆæå‰æ‹¦æˆªï¼‰ |

**ç»“è®º**ï¼š
- æ–¹æ¡ˆBåœ¨æ­£å¸¸æƒ…å†µä¸‹æ€§èƒ½æœ€ä¼˜
- è¿‡æœŸæ˜¯ä½é¢‘äº‹ä»¶ï¼ˆ7å¤©ä¸€æ¬¡ï¼‰ï¼Œ2ç§’å»¶è¿Ÿå¯æ¥å—
- æ–¹æ¡ˆCçš„æ€§èƒ½ä¼˜åŠ¿ä¸æ˜æ˜¾

---

## ğŸ”„ å‡çº§è·¯å¾„

### ä»æ–¹æ¡ˆBå‡çº§åˆ°æ–¹æ¡ˆC
å¦‚æœå°†æ¥éœ€è¦ï¼Œå¯ä»¥è½»æ¾å‡çº§ï¼š

```javascript
// 1. æ·»åŠ ä¸»åŠ¨æ£€æŸ¥ï¼ˆä¸å½±å“ç°æœ‰é€»è¾‘ï¼‰
async function sendMessageWithAutoRenew(conversationId, message, userId, fishIds) {
    // æ–°å¢ï¼šä¸»åŠ¨æ£€æŸ¥
    const conv = await getConversation(conversationId);
    if (conv.expires_at < new Date()) {
        // ç›´æ¥åˆ›å»ºæ–°çš„ï¼Œä¸è°ƒç”¨Coze
        const newConv = await createConversation(userId, fishIds);
        conversationId = newConv.coze_conversation_id;
    }
    
    // åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
    try {
        return await cozeAPI.chat(conversationId, message);
    } catch (error) {
        if (isConversationExpiredError(error)) {
            // ...è‡ªåŠ¨é‡è¯•é€»è¾‘
        }
    }
}

// 2. æ·»åŠ å®šæœŸæ¸…ç†ä»»åŠ¡
setInterval(cleanupExpiredConversations, 24 * 60 * 60 * 1000);
```

---

## ğŸ’¡ æœ€ç»ˆå»ºè®®

### ç«‹å³é‡‡ç”¨ï¼šæ–¹æ¡ˆB
1. âœ… æ»¡è¶³æ‰€æœ‰åŠŸèƒ½éœ€æ±‚
2. âœ… ä»£ç ç®€å•æ˜“ç»´æŠ¤
3. âœ… ç”¨æˆ·ä½“éªŒä¼˜ç§€
4. âœ… æ€§èƒ½è¶³å¤Ÿå¥½
5. âœ… æ˜“äºå‡çº§

### å¯é€‰æ·»åŠ ï¼ˆéå¿…éœ€ï¼‰
1. å®šæœŸæ¸…ç†ä»»åŠ¡ï¼ˆå¦‚æœæ•°æ®åº“å¢é•¿è¿‡å¿«ï¼‰
2. å‰ç«¯è¿‡æœŸæç¤ºï¼ˆå¦‚æœéœ€è¦æ›´å¥½çš„UXï¼‰
3. ç»Ÿè®¡åˆ†æï¼ˆå¦‚æœéœ€è¦æ•°æ®æ´å¯Ÿï¼‰

### ä¸æ¨è
- âŒ æ–¹æ¡ˆAï¼šç”¨æˆ·ä½“éªŒå·®
- âš ï¸ æ–¹æ¡ˆCï¼šè¿‡åº¦è®¾è®¡ï¼Œé™¤éæœ‰æ˜ç¡®æ€§èƒ½éœ€æ±‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-24  
**æœ€åæ›´æ–°**ï¼š2025-11-24
