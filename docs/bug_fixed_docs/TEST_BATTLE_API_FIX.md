# æˆ˜æ–—æµ‹è¯•é¡µé¢APIä¿®å¤è®°å½•

**ä¿®å¤æ—¥æœŸ**: 2025-11-03  
**ä¿®å¤äººå‘˜**: AI Assistant  
**å½±å“æ–‡ä»¶**: test-battle.htmlåŠç›¸å…³API

---

## ğŸ› é—®é¢˜æè¿°

è®¿é—® http://localhost:3000/test-battle.html æ—¶ï¼Œç‚¹å‡»"åŒ¹é…å¯¹æ‰‹"æŒ‰é’®æç¤ºåŒ¹é…å¤±è´¥ã€‚

### é”™è¯¯ä¿¡æ¯

1. **404é”™è¯¯**: `http://localhost:3000/undefined/api/battle/match`
2. **500é”™è¯¯**: `field 'name' not found in type: 'fish'`

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜1: ç¼ºå¤±APIæ–‡ä»¶

æµ‹è¯•é¡µé¢è°ƒç”¨äº†ä¸‰ä¸ªä¸å­˜åœ¨çš„APIç«¯ç‚¹ï¼š
- `/api/battle/match` â†’ `api/battle/match.js` ä¸å­˜åœ¨
- `/api/battle/execute` â†’ `api/battle/execute.js` ä¸å­˜åœ¨  
- `/api/battle/history` â†’ `api/battle/history.js` ä¸å­˜åœ¨

### é—®é¢˜2: BACKEND_URLæœªå®šä¹‰

`test-battle.html`ä¸­æ²¡æœ‰è®¾ç½®`window.BACKEND_URL`ï¼Œå¯¼è‡´API URLå˜æˆ`undefined/api/battle/match`ã€‚

### é—®é¢˜3: æ•°æ®åº“å­—æ®µåé”™è¯¯

APIä»£ç ä¸­ä½¿ç”¨äº†`name`å­—æ®µï¼Œä½†fishè¡¨ä¸­å®é™…å­—æ®µåæ˜¯`artist`ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºç¼ºå¤±çš„APIæ–‡ä»¶

#### api/battle/match.js
**åŠŸèƒ½**: ä¸ºæŒ‡å®šçš„é±¼åŒ¹é…åˆé€‚çš„å¯¹æ‰‹

**å®ç°é€»è¾‘**:
```javascript
// 1. è·å–å½“å‰é±¼çš„æ•°æ®
// 2. éªŒè¯é±¼çš„çŠ¶æ€ï¼ˆå­˜æ´»ã€ç­‰çº§ç­‰ï¼‰
// 3. æŸ¥æ‰¾ç­‰çº§ç›¸è¿‘ï¼ˆÂ±3çº§ï¼‰çš„å¯¹æ‰‹
// 4. æŒ‰æˆ˜æ–—åŠ›æ’åºï¼Œé€‰æ‹©æœ€æ¥è¿‘çš„å¯¹æ‰‹
// 5. è¿”å›åŒ¹é…ç»“æœ
```

**å…³é”®ä»£ç **:
```javascript
const matchQuery = `
  query MatchOpponent($myFishId: uuid!, $minLevel: Int!, $maxLevel: Int!) {
    fish(
      where: {
        id: {_neq: $myFishId}
        is_alive: {_eq: true}
        level: {_gte: $minLevel, _lte: $maxLevel}
      }
      order_by: {battle_power: asc}
      limit: 10
    ) {
      id
      artist
      level
      battle_power
      health
      max_health
    }
  }
`;
```

#### api/battle/execute.js
**åŠŸèƒ½**: æ‰§è¡Œä¸¤æ¡é±¼ä¹‹é—´çš„æˆ˜æ–—

**å®ç°é€»è¾‘**:
```javascript
// 1. è·å–æˆ˜æ–—é…ç½®
// 2. è·å–åŒæ–¹é±¼æ•°æ®
// 3. éªŒè¯åŒæ–¹éƒ½å­˜æ´»
// 4. è°ƒç”¨battleEngine.resolveBattle()ç»“ç®—æˆ˜æ–—
// 5. æ›´æ–°æ•°æ®åº“ï¼ˆç»éªŒã€è¡€é‡ã€èƒœè´Ÿè®°å½•ï¼‰
// 6. è®°å½•æˆ˜æ–—æ—¥å¿—
// 7. å¤±æ•ˆç¼“å­˜
// 8. è¿”å›è¯¦ç»†ç»“æœ
```

**è¿”å›æ•°æ®ç»“æ„**:
```javascript
{
  success: true,
  data: {
    winnerId: "...",
    loserId: "...",
    battle: {
      attackerPower: 45.5,
      defenderPower: 42.3,
      powerDiff: 3.2
    },
    changes: {
      winner: { expGained: 50, levelUp: false },
      loser: { healthLost: 20, isDead: false }
    }
  }
}
```

#### api/battle/history.js
**åŠŸèƒ½**: æŸ¥è¯¢æŒ‡å®šé±¼çš„æˆ˜æ–—å†å²è®°å½•

**å®ç°é€»è¾‘**:
```javascript
// 1. æ¥æ”¶fishIdå‚æ•°
// 2. æŸ¥è¯¢battle_logè¡¨ï¼ˆæ”»å‡»æ–¹æˆ–é˜²å®ˆæ–¹åŒ…å«è¯¥é±¼ï¼‰
// 3. è”è¡¨æŸ¥è¯¢é±¼çš„è‰ºæœ¯å®¶åç§°
// 4. æ ¼å¼åŒ–è¿”å›æ•°æ®ï¼ˆèƒœ/è´Ÿ/å¹³ï¼‰
// 5. è¿”å›ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€»åœºæ¬¡ã€èƒœåœºã€è´¥åœºï¼‰
```

### 2. ä¿®å¤BACKEND_URL

åœ¨`test-battle.html`çš„`<script>`æ ‡ç­¾å‰æ·»åŠ ï¼š
```html
<script>
  window.BACKEND_URL = '';  // å¼€å‘ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
</script>
```

### 3. ä¿®æ­£å­—æ®µå

å°†æ‰€æœ‰APIä¸­çš„`name`å­—æ®µæ”¹ä¸º`artist`å­—æ®µï¼š

**ä¿®æ”¹å‰**:
```javascript
fish_by_pk(id: $id) {
  id
  name  // âŒ é”™è¯¯
  level
}
```

**ä¿®æ”¹å**:
```javascript
fish_by_pk(id: $id) {
  id
  artist  // âœ… æ­£ç¡®
  level
}
```

åŒæ—¶åœ¨è¿”å›æ•°æ®æ—¶æ·»åŠ é»˜è®¤å€¼ï¼š
```javascript
name: myFish.artist || 'Anonymous'
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### åŒ¹é…å¯¹æ‰‹åŠŸèƒ½ âœ…

**æµ‹è¯•è¾“å…¥**:
- é±¼ID: `c01968b6-37af-4262-9444-6df44b71d923`

**æµ‹è¯•è¾“å‡º**:
```json
{
  "success": true,
  "data": {
    "myFish": {
      "id": "c01968b6-37af-4262-9444-6df44b71d923",
      "name": "tey",
      "level": 1,
      "battlePower": 0
    },
    "opponent": {
      "id": "0603d349-c76f-46aa-8698-4ca15e456235",
      "name": "æµ‹è¯•ç”¨æˆ·",
      "level": 1,
      "battlePower": 0
    },
    "matchInfo": {
      "levelDiff": 0,
      "powerDiff": 0,
      "totalCandidates": 1
    }
  }
}
```

**æµ‹è¯•ç»“è®º**: âœ… åŒ¹é…æˆåŠŸï¼Œæ•°æ®æ­£å¸¸è¿”å›

### æ‰§è¡Œæˆ˜æ–—åŠŸèƒ½ â³

æ­£åœ¨æµ‹è¯•ä¸­ï¼ˆAPIåˆ›å»ºå®Œæˆï¼Œç­‰å¾…åç«¯å¤„ç†ï¼‰

### æˆ˜æ–—å†å²åŠŸèƒ½ â¸ï¸

å¾…æµ‹è¯•ï¼ˆéœ€è¦å…ˆæœ‰æˆ˜æ–—è®°å½•ï¼‰

---

## ğŸ“Š æˆ˜æ–—ç³»ç»Ÿæ¶æ„è¯´æ˜

### æˆ˜æ–—å‘ˆç°æ–¹å¼

è¿™æ˜¯ä¸€ä¸ª**ã€Œé±¼ç¼¸å†…ç¢°æ’è§¦å‘ + å³æ—¶æ•°å€¼ç»“ç®—ã€**çš„æˆ˜æ–—ç³»ç»Ÿï¼š

#### æˆ˜æ–—æµç¨‹:
1. **è§¦å‘**: å‰ç«¯æ£€æµ‹ä¸¤æ¡æˆ˜æ–—æ¨¡å¼çš„é±¼ç¢°æ’ï¼ˆè·ç¦»<80pxï¼‰
2. **è¯·æ±‚**: å‰ç«¯è°ƒç”¨`/api/battle/trigger`æˆ–`/api/battle/execute`
3. **ç»“ç®—**: åç«¯è®¡ç®—æˆ˜æ–—åŠ›å¹¶ç¬æ—¶å†³å‡ºèƒœè´Ÿ
   - æˆ˜æ–—åŠ› = ç­‰çº§Ã—40% + å¤©èµ‹Ã—35% + ç‚¹èµÃ—25%
   - åº”ç”¨éšæœºå› å­ï¼ˆÂ±10%æ³¢åŠ¨ï¼‰
4. **æ›´æ–°**: æ•°æ®åº“æ›´æ–°åŒæ–¹çŠ¶æ€ï¼ˆç»éªŒã€è¡€é‡ã€èƒœè´Ÿè®°å½•ï¼‰
5. **åŠ¨ç”»**: å‰ç«¯æ’­æ”¾1ç§’æˆ˜æ–—åŠ¨ç”»ï¼ˆå†²æ’â†’ç¢°æ’â†’ç»“æœï¼‰

#### ç‰¹ç‚¹åˆ†æ:
- âœ… **ä¸æ˜¯å›åˆåˆ¶**: æ²¡æœ‰å›åˆæ¦‚å¿µï¼Œç¢°æ’å³ç»“ç®—
- âœ… **ä¸æ˜¯å®æ—¶æˆ˜æ–—**: ä¸éœ€ç©å®¶å®æ—¶æ“ä½œ
- âœ… **æ˜¯ç¢°æ’è§¦å‘**: é±¼åœ¨é±¼ç¼¸å†…è‡ªç”±æ¸¸åŠ¨ï¼Œç¢°æ’è§¦å‘æˆ˜æ–—
- âœ… **è§†è§‰å‹å¥½**: è™½ç„¶åç«¯ç¬æ—¶ç»“ç®—ï¼Œä½†å‰ç«¯æœ‰æµç•…åŠ¨ç”»

### ç›¸å…³æ–‡ä»¶

**å‰ç«¯**:
- `test-battle.html` - æˆ˜æ–—æµ‹è¯•é¡µé¢
- `src/js/battle-animation.js` - æˆ˜æ–—åŠ¨ç”»
- `battle-demo.html` - å®Œæ•´æˆ˜æ–—æ¼”ç¤º

**åç«¯API**:
- `api/battle/match.js` - åŒ¹é…å¯¹æ‰‹ âœ… æ–°å¢
- `api/battle/execute.js` - æ‰§è¡Œæˆ˜æ–— âœ… æ–°å¢
- `api/battle/history.js` - æˆ˜æ–—å†å² âœ… æ–°å¢
- `api/battle/trigger.js` - è§¦å‘æˆ˜æ–—ï¼ˆé±¼ç¼¸ç¢°æ’ç”¨ï¼‰
- `api/battle/resolve.js` - ç»“ç®—æˆ˜æ–—ï¼ˆå¤‡ç”¨ï¼‰

**æ ¸å¿ƒé€»è¾‘**:
- `lib/battle-engine.js` - æˆ˜æ–—å¼•æ“ï¼ˆæˆ˜æ–—åŠ›è®¡ç®—ã€å‡çº§ï¼‰
- `lib/hasura.js` - Hasura GraphQLå®¢æˆ·ç«¯
- `lib/redis.js` - Redisç¼“å­˜

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### æ•°æ®åº“å­—æ®µæ˜ å°„

fishè¡¨ä¸­**æ²¡æœ‰`name`å­—æ®µ**ï¼Œä½¿ç”¨`artist`å­—æ®µå­˜å‚¨åˆ›å»ºè€…åç§°ï¼š

| APIè¿”å› | æ•°æ®åº“å­—æ®µ | è¯´æ˜ |
|---------|-----------|------|
| name | artist | è‰ºæœ¯å®¶/åˆ›å»ºè€…åç§° |
| id | id | UUIDä¸»é”® |
| level | level | ç­‰çº§ |
| battlePower | battle_power | æˆ˜æ–—åŠ› |

### BACKEND_URLé…ç½®

ä¸åŒç¯å¢ƒçš„é…ç½®ï¼š
```javascript
// å¼€å‘ç¯å¢ƒï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰
window.BACKEND_URL = '';  // ç©ºå­—ç¬¦ä¸² = ç›¸å¯¹è·¯å¾„

// ç”Ÿäº§ç¯å¢ƒï¼ˆVerceléƒ¨ç½²ï¼‰
window.BACKEND_URL = '';  // ä»ç„¶ç”¨ç›¸å¯¹è·¯å¾„

// è·¨åŸŸç¯å¢ƒï¼ˆå¦‚æœå‰åç«¯åˆ†ç¦»ï¼‰
window.BACKEND_URL = 'https://api.example.com';
```

### APIå“åº”æ ¼å¼

æ‰€æœ‰æˆ˜æ–—ç›¸å…³APIéµå¾ªç»Ÿä¸€æ ¼å¼ï¼š
```javascript
// æˆåŠŸ
{
  success: true,
  data: { ... }
}

// å¤±è´¥
{
  success: false,
  error: "é”™è¯¯æè¿°",
  details: "è¯¦ç»†ä¿¡æ¯"  // ä»…å¼€å‘ç¯å¢ƒ
}
```

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**
   - ä¸ºfishè¡¨çš„`level`å’Œ`battle_power`å­—æ®µæ·»åŠ ç´¢å¼•
   - ä½¿ç”¨Redisç¼“å­˜çƒ­é—¨åŒ¹é…æŸ¥è¯¢

2. **åŒ¹é…ç®—æ³•æ”¹è¿›**
   - è€ƒè™‘æˆ˜æ–—åŠ›å·®è·è¿‡å¤§æ—¶æ‹’ç»åŒ¹é…
   - æ·»åŠ åŒ¹é…å†å²é¿å…é‡å¤å¯¹æˆ˜
   - å®ç°ELOåŒ¹é…ç³»ç»Ÿ

3. **ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ åŒ¹é…é˜Ÿåˆ—åŠ¨ç”»
   - æ˜¾ç¤ºé¢„ä¼°æˆ˜æ–—ç»“æœ
   - æ·»åŠ æˆ˜æ–—å›æ”¾åŠŸèƒ½

4. **æ•°æ®ç»Ÿè®¡**
   - è®°å½•æ›´è¯¦ç»†çš„æˆ˜æ–—æ•°æ®ï¼ˆå›åˆè¯¦æƒ…ã€æŠ€èƒ½ä½¿ç”¨ç­‰ï¼‰
   - ç”Ÿæˆæˆ˜æ–—åŠ›æ›²çº¿å›¾
   - æ’è¡Œæ¦œç³»ç»Ÿ

---

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âš ï¸ éƒ¨åˆ†åŠŸèƒ½å¾…è¿›ä¸€æ­¥æµ‹è¯•  
**å½±å“èŒƒå›´**: æˆ˜æ–—æµ‹è¯•é¡µé¢åŠç›¸å…³API






