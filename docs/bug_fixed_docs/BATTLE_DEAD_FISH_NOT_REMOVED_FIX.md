# æˆ˜æ–—æ¨¡å¼æ­»äº¡é±¼æœªæ¶ˆå¤±é—®é¢˜ä¿®å¤

**æ—¥æœŸ**: 2025-11-05  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šåœ¨æˆ˜æ–—æ¨¡å¼ä¸­ï¼Œæœ‰çš„é±¼å·²ç»æ²¡è¡€äº†ä½†æ²¡æ¶ˆå¤±ï¼Œä»ç„¶æ˜¾ç¤ºåœ¨é±¼ç¼¸ä¸­ã€‚

## é—®é¢˜åŸå› 

ç»è¿‡åˆ†æï¼Œå‘ç°æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜å¯¼è‡´æ­»äº¡çš„é±¼æ²¡æœ‰è¢«æ­£ç¡®ç§»é™¤ï¼š

### 1. æ­»äº¡åˆ¤å®šä½¿ç”¨ä¸¥æ ¼ç›¸ç­‰

**é—®é¢˜ä»£ç ** (`lib/battle-engine.js` è¡Œ 88):
```javascript
const isDead = newHealth === 0;
```

**é—®é¢˜åˆ†æ**ï¼š
- ä½¿ç”¨ `=== 0` è¿›è¡Œä¸¥æ ¼ç›¸ç­‰åˆ¤æ–­
- å¯èƒ½å› ä¸ºæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜å¯¼è‡´åˆ¤å®šå¤±è´¥
- ä¾‹å¦‚ï¼š`0.0000001` ä¸ç­‰äº `0`ï¼Œä½†å®é™…ä¸Šé±¼å·²ç»æ²¡è¡€äº†

### 2. é±¼ç§»é™¤ä¾èµ–å¯¹è±¡å¼•ç”¨

**é—®é¢˜ä»£ç ** (`src/js/tank.js` è¡Œ 1990):
```javascript
setTimeout(() => {
    const index = fishes.indexOf(loserFish);
    if (index !== -1) {
        fishes.splice(index, 1);
    }
}, 2000);
```

**é—®é¢˜åˆ†æ**ï¼š
- ä½¿ç”¨ `indexOf` æŸ¥æ‰¾é±¼å¯¹è±¡
- å¦‚æœåœ¨2ç§’å†…é±¼å¯¹è±¡è¢«ä¿®æ”¹æˆ–æ›¿æ¢ï¼Œå¯èƒ½æ‰¾ä¸åˆ°
- å¯¹è±¡å¼•ç”¨å¯èƒ½ä¼šå¤±æ•ˆ

### 3. åŠ è½½é±¼æ—¶ç¼ºå°‘å¥åº·å€¼æ£€æŸ¥

**é—®é¢˜ä»£ç ** (`src/js/tank.js` è¡Œ 56-82):
```javascript
for (const fishDoc of allFishDocs) {
    // ç›´æ¥åŠ è½½æ‰€æœ‰é±¼ï¼Œæ²¡æœ‰æ£€æŸ¥ health
    loadFishImageToTank(...);
}
```

**é—®é¢˜åˆ†æ**ï¼š
- åŠ è½½é±¼æ—¶åªæ£€æŸ¥äº† `is_alive`ï¼ˆåœ¨ GraphQL æŸ¥è¯¢ä¸­ï¼‰
- ä½†å¦‚æœæ•°æ®åº“ä¸­æœ‰ `is_alive = true` ä½† `health = 0` çš„æ•°æ®ä¸ä¸€è‡´æƒ…å†µ
- è¿™äº›é±¼ä¼šè¢«åŠ è½½åˆ°é±¼ç¼¸ä¸­

### 4. ç¼ºå°‘æŒç»­çš„å¥åº·å€¼æ£€æŸ¥

**é—®é¢˜åˆ†æ**ï¼š
- åŠ¨ç”»å¾ªç¯ä¸­åªå¤„ç† `isDying` æ ‡å¿—
- å¦‚æœé±¼çš„å¥åº·å€¼åœ¨å…¶ä»–æƒ…å†µä¸‹å˜ä¸º0ï¼ˆä¾‹å¦‚æ•°æ®åŒæ­¥ï¼‰ï¼Œæ²¡æœ‰è‡ªåŠ¨å¯åŠ¨æ­»äº¡åŠ¨ç”»
- éœ€è¦æŒç»­ç›‘æµ‹é±¼çš„å¥åº·çŠ¶æ€

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: æ”¹è¿›æ­»äº¡åˆ¤å®šé€»è¾‘

**æ–‡ä»¶**: `lib/battle-engine.js` (è¡Œ 88)

```javascript
// ä¿®å¤å‰
const isDead = newHealth === 0;

// ä¿®å¤å
const isDead = newHealth <= 0; // ä½¿ç”¨ <= 0 é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `<= 0` åˆ¤æ–­ï¼Œå…¼å®¹æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
- âœ… ç¡®ä¿ä»»ä½•å°äºç­‰äº0çš„å¥åº·å€¼éƒ½åˆ¤å®šä¸ºæ­»äº¡
- âœ… æ›´åŠ å¥å£®å’Œå¯é 

### ä¿®å¤2: æ”¹è¿›é±¼ç§»é™¤é€»è¾‘

**æ–‡ä»¶**: `src/js/tank.js` (è¡Œ 1988-1998)

```javascript
// ä¿®å¤å
// 2ç§’åä»é±¼ç¼¸ä¸­ç§»é™¤ - ä½¿ç”¨ docId æŸ¥æ‰¾ä»¥é¿å…å¯¹è±¡å¼•ç”¨é—®é¢˜
const deadFishId = loserFish.docId || loserFish.id;
setTimeout(() => {
    const index = fishes.findIndex(f => (f.docId || f.id) === deadFishId);
    if (index !== -1) {
        fishes.splice(index, 1);
        console.log(`  ğŸ—‘ï¸ å·²ä»é±¼ç¼¸ç§»é™¤æ­»äº¡çš„é±¼ (ID: ${deadFishId})`);
    } else {
        console.warn(`  âš ï¸ æœªæ‰¾åˆ°è¦ç§»é™¤çš„æ­»äº¡é±¼ (ID: ${deadFishId})`);
    }
}, 2000);
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `docId` æˆ– `id` æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯å¯¹è±¡å¼•ç”¨
- âœ… ä½¿ç”¨ `findIndex` ä»£æ›¿ `indexOf`
- âœ… æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—
- âœ… å³ä½¿å¯¹è±¡è¢«ä¿®æ”¹ï¼Œä¹Ÿèƒ½é€šè¿‡IDæ‰¾åˆ°

### ä¿®å¤3: åŠ è½½æ—¶è¿‡æ»¤æ­»äº¡çš„é±¼

**æ–‡ä»¶**: `src/js/tank.js` (è¡Œ 68-72)

```javascript
// è·³è¿‡å·²æ­»äº¡æˆ–æ— è¡€é‡çš„é±¼
if (fishData.is_alive === false || (fishData.health !== undefined && fishData.health <= 0)) {
    console.log(`â­ï¸ è·³è¿‡æ­»äº¡çš„é±¼: ${fishData.artist || fishData.id} (health: ${fishData.health})`);
    continue;
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ£€æŸ¥ `is_alive` çŠ¶æ€
- âœ… æ£€æŸ¥ `health` å€¼
- âœ… é˜²æ­¢åŠ è½½å·²æ­»äº¡çš„é±¼
- âœ… å¤„ç†æ•°æ®åº“æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ

### ä¿®å¤4: åœ¨åŠ¨ç”»å¾ªç¯ä¸­æŒç»­æ£€æŸ¥å¥åº·å€¼

**æ–‡ä»¶**: `src/js/tank.js` (è¡Œ 1558-1586)

```javascript
// æ£€æŸ¥é±¼çš„å¥åº·å€¼ï¼Œå¦‚æœå·²æ­»äº¡ä½†è¿˜æ²¡å¼€å§‹æ­»äº¡åŠ¨ç”»ï¼Œå¯åŠ¨æ­»äº¡åŠ¨ç”»
if (!fish.isDying && !fish.isEntering && isBattleMode) {
    const fishHealth = fish.health !== undefined ? fish.health : (fish.max_health || 100);
    const isAlive = fish.is_alive !== undefined ? fish.is_alive : true;
    
    if (!isAlive || fishHealth <= 0) {
        console.log(`â˜ ï¸ æ£€æµ‹åˆ°æ­»äº¡çš„é±¼: ${fish.artist || fish.docId} (health: ${fishHealth}, is_alive: ${isAlive})`);
        
        // å¯åŠ¨æ­»äº¡åŠ¨ç”»
        fish.isDying = true;
        fish.deathStartTime = Date.now();
        fish.deathDuration = 2000;
        fish.originalY = fish.y;
        fish.opacity = 1;
        fish.direction = -Math.abs(fish.direction);
        fish.health = 0;
        fish.is_alive = false;
        
        // 2ç§’åç§»é™¤
        const deadFishId = fish.docId || fish.id;
        setTimeout(() => {
            const index = fishes.findIndex(f => (f.docId || f.id) === deadFishId);
            if (index !== -1) {
                fishes.splice(index, 1);
                console.log(`ğŸ—‘ï¸ å·²è‡ªåŠ¨ç§»é™¤æ­»äº¡çš„é±¼ (ID: ${deadFishId})`);
            }
        }, 2000);
    }
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… åœ¨æ¯ä¸€å¸§æ£€æŸ¥é±¼çš„å¥åº·çŠ¶æ€
- âœ… è‡ªåŠ¨æ£€æµ‹ `health <= 0` æˆ– `is_alive = false` çš„é±¼
- âœ… è‡ªåŠ¨å¯åŠ¨æ­»äº¡åŠ¨ç”»
- âœ… ç¡®ä¿æ­»äº¡çš„é±¼æœ€ç»ˆä¼šè¢«ç§»é™¤
- âœ… åªåœ¨æˆ˜æ–—æ¨¡å¼ä¸‹æ£€æŸ¥ï¼ˆé¿å…å½±å“æ™®é€šæ¨¡å¼ï¼‰

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜

1. âŒ é±¼è¡€é‡ä¸º0ä½†ä»ç„¶æ˜¾ç¤ºåœ¨é±¼ç¼¸ä¸­
2. âŒ æ­»äº¡çš„é±¼ä¸ä¼šæ¶ˆå¤±
3. âŒ é±¼ç¼¸ä¸­å¯èƒ½å‡ºç°"åƒµå°¸é±¼"ï¼ˆæ— è¡€ä½†æ´»ç€ï¼‰
4. âŒ æ•°æ®åº“ä¸­æ ‡è®°ä¸ºæ­»äº¡çš„é±¼ä»ç„¶æ˜¾ç¤º

### ä¿®å¤åçš„æ•ˆæœ

1. âœ… æ­»äº¡åˆ¤å®šæ›´åŠ å‡†ç¡®ï¼ˆä½¿ç”¨ `<= 0`ï¼‰
2. âœ… é±¼ç§»é™¤é€»è¾‘æ›´åŠ å¯é ï¼ˆä½¿ç”¨IDæŸ¥æ‰¾ï¼‰
3. âœ… åŠ è½½æ—¶è‡ªåŠ¨è¿‡æ»¤æ­»äº¡çš„é±¼
4. âœ… åŠ¨ç”»å¾ªç¯ä¸­æŒç»­ç›‘æµ‹å¥åº·å€¼
5. âœ… æ­»äº¡çš„é±¼ä¼šè‡ªåŠ¨æ’­æ”¾æ­»äº¡åŠ¨ç”»å¹¶ç§»é™¤
6. âœ… ä¸ä¼šå†å‡ºç°"åƒµå°¸é±¼"

## æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸æˆ˜æ–—æ­»äº¡

1. è¿›å…¥æˆ˜æ–—æ¨¡å¼
2. è®©ä¸¤æ¡é±¼æˆ˜æ–—
3. è§‚å¯Ÿå¤±è´¥æ–¹è¡€é‡å‡å°‘
4. å½“è¡€é‡é™è‡³0æ—¶ï¼Œåº”è¯¥ï¼š
   - ç«‹å³ç¿»è½¬ï¼ˆè‚šçš®æœä¸Šï¼‰
   - å¼€å§‹ä¸‹æ²‰å’Œæ·¡å‡ºåŠ¨ç”»
   - 2ç§’åä»é±¼ç¼¸ä¸­æ¶ˆå¤±

### æµ‹è¯•åœºæ™¯2ï¼šå¤šæ¬¡æˆ˜æ–—ç›´è‡³æ­»äº¡

1. è®©ä¸€æ¡é±¼è¿›è¡Œå¤šæ¬¡æˆ˜æ–—
2. è§‚å¯Ÿè¡€é‡é€æ¸å‡å°‘
3. æœ€åä¸€æ¬¡æˆ˜æ–—åè¡€é‡åº”è¯¥é™è‡³0
4. é±¼åº”è¯¥æ­£ç¡®æ’­æ”¾æ­»äº¡åŠ¨ç”»å¹¶ç§»é™¤

### æµ‹è¯•åœºæ™¯3ï¼šåŠ è½½å·²æ­»äº¡çš„é±¼

1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€æ¡ `health = 0` çš„é±¼
2. é‡æ–°åŠ è½½æˆ˜æ–—æ¨¡å¼
3. è¯¥é±¼åº”è¯¥ä¸ä¼šè¢«åŠ è½½åˆ°é±¼ç¼¸ä¸­
4. æ§åˆ¶å°åº”è¯¥æ˜¾ç¤º"â­ï¸ è·³è¿‡æ­»äº¡çš„é±¼"

### æµ‹è¯•åœºæ™¯4ï¼šæ•°æ®åŒæ­¥

1. é±¼åœ¨æˆ˜æ–—ä¸­æ­»äº¡
2. æ£€æŸ¥æ•°æ®åº“ä¸­ `is_alive` å’Œ `health` å­—æ®µ
3. åº”è¯¥æ­£ç¡®æ›´æ–°ä¸º `is_alive = false, health = 0`
4. é‡æ–°åŠ è½½é¡µé¢ï¼Œæ­»äº¡çš„é±¼ä¸åº”è¯¥å‡ºç°

## ç›¸å…³æ–‡ä»¶

- `lib/battle-engine.js` - æˆ˜æ–—å¼•æ“ï¼ˆæ­»äº¡åˆ¤å®šé€»è¾‘ï¼‰
- `src/js/tank.js` - é±¼ç¼¸ä¸»é€»è¾‘ï¼ˆé±¼åŠ è½½ã€åŠ¨ç”»ã€ç§»é™¤ï¼‰
- `src/js/fish-utils.js` - é±¼æ•°æ®åŠ è½½å·¥å…·

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤é€šè¿‡4ä¸ªå±‚é¢çš„æ”¹è¿›ï¼Œç¡®ä¿äº†æ­»äº¡çš„é±¼èƒ½å¤Ÿæ­£ç¡®åœ°è¢«æ£€æµ‹ã€æ ‡è®°ã€åŠ¨ç”»å’Œç§»é™¤ï¼š

1. **åç«¯åˆ¤å®šå±‚**ï¼šæ”¹è¿›æ­»äº¡åˆ¤å®šé€»è¾‘ï¼Œä½¿ç”¨ `<= 0` é¿å…ç²¾åº¦é—®é¢˜
2. **ç§»é™¤é€»è¾‘å±‚**ï¼šä½¿ç”¨IDæŸ¥æ‰¾æ›¿ä»£å¯¹è±¡å¼•ç”¨ï¼Œæé«˜å¯é æ€§
3. **åŠ è½½è¿‡æ»¤å±‚**ï¼šåœ¨åŠ è½½æ—¶è¿‡æ»¤æ‰å·²æ­»äº¡çš„é±¼ï¼Œé˜²æ­¢"åƒµå°¸é±¼"
4. **è¿è¡Œæ—¶ç›‘æµ‹å±‚**ï¼šæŒç»­æ£€æŸ¥é±¼çš„å¥åº·çŠ¶æ€ï¼Œè‡ªåŠ¨è§¦å‘æ­»äº¡åŠ¨ç”»

è¿™äº›æ”¹è¿›ç¡®ä¿äº†æˆ˜æ–—ç³»ç»Ÿçš„é²æ£’æ€§å’Œç”¨æˆ·ä½“éªŒï¼ğŸ‰










